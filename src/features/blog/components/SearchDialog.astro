---
---

<dialog
  id="search-dialog"
  class="fixed inset-0 z-[100] w-full h-full bg-transparent p-0 m-0 max-w-none max-h-none"
>
  <div
    id="search-backdrop"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm"
  >
  </div>
  <div
    class="fixed inset-0 flex items-start justify-center pt-[10vh] px-4 pointer-events-none"
  >
    <div
      class="relative w-full max-w-2xl bg-background rounded-2xl shadow-2xl border border-background-lighter pointer-events-auto overflow-hidden"
    >
      <div class="flex items-center justify-between px-4 py-3 border-b border-background-lighter">
        <span class="text-sm text-text-muted">검색</span>
        <div class="flex items-center gap-2">
          <kbd
            class="hidden sm:inline-flex items-center px-1.5 py-0.5 text-xs text-text-muted bg-background-muted rounded border border-gray-200"
            >ESC</kbd
          >
          <button
            id="search-close"
            type="button"
            class="text-text-muted hover:text-text transition-colors"
            aria-label="검색 닫기"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      <div id="pagefind-search" class="pagefind-search-container"></div>
    </div>
  </div>
</dialog>

<style is:global>
  /* Pagefind UI theme integration */
  .pagefind-search-container {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: var(--color-primary);
    --pagefind-ui-text: var(--color-text);
    --pagefind-ui-background: var(--color-background);
    --pagefind-ui-border: var(--color-background-lighter);
    --pagefind-ui-tag: var(--color-primary-lighter);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 12px;
    --pagefind-ui-font: var(--font-body);
  }

  .pagefind-search-container .pagefind-ui__search-input {
    font-family: var(--font-body);
    border: none !important;
    box-shadow: none !important;
    outline: none !important;
    background: transparent !important;
    padding: 0.75rem 1rem !important;
    font-size: 1rem !important;
  }

  .pagefind-search-container .pagefind-ui__search-clear {
    right: 1rem !important;
  }

  .pagefind-search-container .pagefind-ui__form::before {
    display: none !important;
  }

  .pagefind-search-container .pagefind-ui__results-area {
    max-height: 60vh;
    overflow-y: auto;
    padding: 0 0.5rem 0.5rem;
  }

  .pagefind-search-container .pagefind-ui__result {
    border-radius: 8px;
    padding: 0.75rem !important;
    border: none !important;
  }

  .pagefind-search-container .pagefind-ui__result:hover {
    background: var(--color-background-lighter);
  }

  .pagefind-search-container .pagefind-ui__result-link {
    color: var(--color-primary) !important;
    font-weight: 600;
  }

  .pagefind-search-container .pagefind-ui__result-excerpt {
    color: var(--color-text-light) !important;
    font-size: 0.875rem !important;
  }

  /* Dialog open state */
  dialog#search-dialog[open] {
    display: flex;
  }

  dialog#search-dialog::backdrop {
    display: none;
  }
</style>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet" />

<script is:inline>
  function getSearchDialogState() {
    var key = "__searchDialogState";
    var existing = window[key];

    if (existing) return existing;

    var state = {
      pagefindLoaded: false,
      pagefindLoading: false,
      loadError: false,
      pendingKey: "",
      keydownHandler: null,
    };

    window[key] = state;
    return state;
  }

  function renderSearchUnavailableMessage() {
    var container = document.getElementById("pagefind-search");
    if (!container) return;

    container.innerHTML =
      '<div class="search-unavailable">검색 인덱스를 불러오지 못했습니다. `bun run build` 후 `bun run preview`로 확인해주세요.</div>';
  }

  function focusSearchInput() {
    var input = document.querySelector(".pagefind-ui__search-input");
    if (!(input instanceof HTMLInputElement)) return null;

    if (input.hasAttribute("disabled")) {
      input.removeAttribute("disabled");
    }

    if (input.hasAttribute("readonly")) {
      input.removeAttribute("readonly");
    }

    input.focus();
    return input;
  }

  function applyPendingKey(state) {
    if (!state.pendingKey) return;

    var input = focusSearchInput();
    if (!input) return;

    var start = input.selectionStart ?? input.value.length;
    var end = input.selectionEnd ?? input.value.length;
    input.setRangeText(state.pendingKey, start, end, "end");
    input.dispatchEvent(new Event("input", { bubbles: true }));
    state.pendingKey = "";
  }

  async function canLoadPagefindIndex() {
    try {
      var response = await fetch("/pagefind/pagefind-entry.json", {
        method: "HEAD",
        cache: "no-store",
      });

      return response.ok;
    } catch (error) {
      console.warn("Failed to check Pagefind index:", error);
      return false;
    }
  }

  function initSearchDialog() {
    const state = getSearchDialogState();
    var dialog = document.getElementById("search-dialog");
    const backdrop = document.getElementById("search-backdrop");
    const closeBtn = document.getElementById("search-close");
    const openBtns = document.querySelectorAll("[data-search-trigger]");

    if (!dialog) return;

    async function loadPagefind() {
      if (state.pagefindLoaded || state.pagefindLoading || state.loadError) return;

      state.pagefindLoading = true;

      try {
        var hasIndex = await canLoadPagefindIndex();
        if (!hasIndex) {
          state.loadError = true;
          renderSearchUnavailableMessage();
          console.warn("Pagefind index not found. Run `bun run build` and use preview mode.");
          return;
        }

        var PagefindUI = (await import("/pagefind/pagefind-ui.js")).PagefindUI;
        new PagefindUI({
          element: "#pagefind-search",
          showSubResults: true,
          showImages: false,
        });
        state.pagefindLoaded = true;

        // Focus input after loading
        setTimeout(function() {
          focusSearchInput();
          applyPendingKey(state);
        }, 100);
      } catch (error) {
        state.loadError = true;
        renderSearchUnavailableMessage();
        console.warn("Pagefind failed to initialize:", error);
      } finally {
        state.pagefindLoading = false;
      }
    }

    function openSearch() {
      if (dialog.open) return;

      dialog?.showModal();
      loadPagefind();

      // Focus existing input if already loaded
      if (state.pagefindLoaded) {
        setTimeout(function() {
          focusSearchInput();
          applyPendingKey(state);
        }, 50);
      }
    }

    function closeSearch() {
      dialog?.close();
    }

    // Open triggers
    for (const btn of openBtns) {
      btn.addEventListener("click", openSearch);
    }

    // Close triggers
    closeBtn?.addEventListener("click", closeSearch);
    backdrop?.addEventListener("click", closeSearch);

    // Keyboard shortcuts
    if (state.keydownHandler) {
      document.removeEventListener("keydown", state.keydownHandler);
    }

    state.keydownHandler = function(e) {
      // Ctrl+K or Cmd+K to open
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        if (dialog?.open) {
          closeSearch();
        } else {
          openSearch();
        }
      }
      // ESC to close (native dialog handles this, but just in case)
      if (e.key === "Escape" && dialog?.open) {
        closeSearch();
      }

      if (!dialog?.open || e.ctrlKey || e.metaKey || e.altKey) return;

      var isPrintableKey = e.key.length === 1;
      if (!isPrintableKey) return;

      var input = document.querySelector(".pagefind-ui__search-input");

      if (input instanceof HTMLInputElement && document.activeElement !== input) {
        state.pendingKey = e.key;
        applyPendingKey(state);
        e.preventDefault();
      }
    };

    document.addEventListener("keydown", state.keydownHandler);

    dialog.addEventListener("click", function() {
      if (!state.pagefindLoaded) return;

      setTimeout(function() {
        focusSearchInput();
      }, 0);
    });
  }

  // View Transitions-safe lifecycle
  document.addEventListener("DOMContentLoaded", initSearchDialog);
  document.addEventListener("astro:page-load", initSearchDialog);
</script>
