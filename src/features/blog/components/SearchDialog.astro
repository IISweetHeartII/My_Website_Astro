---
---

<dialog
  id="search-dialog"
  class="fixed inset-0 z-[100] w-full h-full bg-transparent p-0 m-0 max-w-none max-h-none"
>
  <div
    id="search-backdrop"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm"
  >
  </div>
  <div
    class="fixed inset-0 flex items-start justify-center pt-[10vh] px-4 pointer-events-none"
  >
    <div
      class="relative w-full max-w-2xl bg-background rounded-2xl shadow-2xl border border-background-lighter pointer-events-auto overflow-hidden"
    >
      <div class="flex items-center justify-between px-4 py-3 border-b border-background-lighter">
        <span class="text-sm text-text-muted">검색</span>
        <div class="flex items-center gap-2">
          <kbd
            class="hidden sm:inline-flex items-center px-1.5 py-0.5 text-xs text-text-muted bg-background-muted rounded border border-gray-200"
            >ESC</kbd
          >
          <button
            id="search-close"
            type="button"
            class="text-text-muted hover:text-text transition-colors"
            aria-label="검색 닫기"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      <div id="pagefind-search" class="pagefind-search-container"></div>
    </div>
  </div>
</dialog>

<style is:global>
  /* Pagefind UI theme integration */
  .pagefind-search-container {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: var(--color-primary);
    --pagefind-ui-text: var(--color-text);
    --pagefind-ui-background: var(--color-background);
    --pagefind-ui-border: var(--color-background-lighter);
    --pagefind-ui-tag: var(--color-primary-lighter);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 12px;
    --pagefind-ui-font: var(--font-body);
  }

  .pagefind-search-container .pagefind-ui__search-input {
    font-family: var(--font-body);
    border: none !important;
    box-shadow: none !important;
    outline: none !important;
    background: transparent !important;
    padding: 0.75rem 1rem !important;
    font-size: 1rem !important;
  }

  .pagefind-search-container .pagefind-ui__search-clear {
    right: 1rem !important;
  }

  .pagefind-search-container .pagefind-ui__form::before {
    display: none !important;
  }

  .pagefind-search-container .pagefind-ui__results-area {
    max-height: 60vh;
    overflow-y: auto;
    padding: 0 0.5rem 0.5rem;
  }

  .pagefind-search-container .pagefind-ui__result {
    border-radius: 8px;
    padding: 0.75rem !important;
    border: none !important;
  }

  .pagefind-search-container .pagefind-ui__result:hover {
    background: var(--color-background-lighter);
  }

  .pagefind-search-container .pagefind-ui__result-link {
    color: var(--color-primary) !important;
    font-weight: 600;
  }

  .pagefind-search-container .pagefind-ui__result-excerpt {
    color: var(--color-text-light) !important;
    font-size: 0.875rem !important;
  }

  /* Dialog open state */
  dialog#search-dialog[open] {
    display: flex;
  }

  dialog#search-dialog::backdrop {
    display: none;
  }
</style>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet" />

<script is:inline>
  function initSearchDialog() {
    var dialog = document.getElementById("search-dialog");
    const backdrop = document.getElementById("search-backdrop");
    const closeBtn = document.getElementById("search-close");
    const openBtns = document.querySelectorAll("[data-search-trigger]");

    let pagefindLoaded = false;

    async function loadPagefind() {
      if (pagefindLoaded) return;
      try {
        var PagefindUI = (await import("/pagefind/pagefind-ui.js")).PagefindUI;
        new PagefindUI({
          element: "#pagefind-search",
          showSubResults: true,
          showImages: false,
        });
        pagefindLoaded = true;

        // Focus input after loading
        setTimeout(function() {
          var input = document.querySelector(".pagefind-ui__search-input");
          if (input) input.focus();
        }, 100);
      } catch {
        console.warn("Pagefind not available — run a build first to generate the index.");
      }
    }

    function openSearch() {
      dialog?.showModal();
      loadPagefind();
      // Focus existing input if already loaded
      if (pagefindLoaded) {
        setTimeout(function() {
          var input = document.querySelector(".pagefind-ui__search-input");
          if (input) input.focus();
        }, 50);
      }
    }

    function closeSearch() {
      dialog?.close();
    }

    // Open triggers
    for (const btn of openBtns) {
      btn.addEventListener("click", openSearch);
    }

    // Close triggers
    closeBtn?.addEventListener("click", closeSearch);
    backdrop?.addEventListener("click", closeSearch);

    // Keyboard shortcuts
    document.addEventListener("keydown", function(e) {
      // Ctrl+K or Cmd+K to open
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        if (dialog?.open) {
          closeSearch();
        } else {
          openSearch();
        }
      }
      // ESC to close (native dialog handles this, but just in case)
      if (e.key === "Escape" && dialog?.open) {
        closeSearch();
      }
    });
  }

  // Init on DOMContentLoaded and after View Transitions
  document.addEventListener("DOMContentLoaded", initSearchDialog);
  document.addEventListener("astro:after-swap", initSearchDialog);
</script>
