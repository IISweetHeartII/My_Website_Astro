---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';  
import Comments from '../components/Comments.astro';
import { getUrl } from '../utils/url';
import GoogleAnalytics from '../components/GoogleAnalytics.astro';

interface Props extends Pick<CollectionEntry<'blog'>, 'data'> {}

const {
    data: {
        title,
        subtitle,
        description = '',
        created_date,
        updated_date,
        featured_image,
        featured_image_alt,
        tags = [],
        meta_title,
        meta_description,
        canonical_url,
        og_title,
        og_description,
        og_image,
        og_type,
        twitter_title,
        twitter_description,
        twitter_image,
        twitter_card,
        keywords,
        author,
        no_index,
    }
} = Astro.props;

const safeTags = tags ?? [];

// 포스트 slug 추출 (URL 경로에서)
const postSlug = Astro.url.pathname.replace('/blog/', '').replace('/', '') || 'unknown';
---

<html lang="ko">
	<head>
		<GoogleAnalytics />
		<BaseHead
			title={title ?? ''}
			description={description ?? ''}
			featured_image={featured_image ?? ''}
			featured_image_alt={featured_image_alt ?? ''}
			meta_title={meta_title ?? ''}
			meta_description={meta_description ?? ''}
			canonical_url={canonical_url ?? ''}
			og_title={og_title ?? ''}
			og_description={og_description ?? ''}
			og_image={og_image ?? ''}
			og_type={og_type ?? ''}
			twitter_title={twitter_title ?? ''}
			twitter_description={twitter_description ?? ''}
			twitter_image={twitter_image ?? ''}
			twitter_card={twitter_card ?? ''}
			keywords={[...safeTags, ...(keywords || [])]}
			author={author ?? ''}
			no_index={no_index}
		/>
		<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4653332352131854" crossorigin="anonymous"></script>
		<style>
			:global(.mermaid) {
				background: rgb(248, 250, 252);
				padding: 1.5rem;
				border-radius: 0.5rem;
				margin: 1rem 0;
			}
			/* Force prose content to take full width */
			.prose {
				max-width: none !important;
				width: 100%;
			}
			/* 마크다운 강조 표시 스타일링 */
			.prose strong, .prose b {
				font-weight: 700 !important;
				color: theme('colors.text.DEFAULT') !important;
			}
			.prose em, .prose i {
				font-style: italic !important;
			}
			/* 추가적인 마크다운 스타일링 */
			.prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
				font-weight: 700 !important;
				color: theme('colors.text.DEFAULT') !important;
				margin-top: 2rem !important;
				margin-bottom: 1rem !important;
			}
			.prose blockquote {
				border-left: 4px solid theme('colors.accent.DEFAULT') !important;
				padding-left: 1rem !important;
				margin: 1.5rem 0 !important;
				font-style: italic !important;
				background: theme('colors.background.light') !important;
				padding: 1rem !important;
				border-radius: 0.5rem !important;
			}
			.prose code {
				background: theme('colors.background.lighter') !important;
				padding: 0.125rem 0.25rem !important;
				border-radius: 0.25rem !important;
				font-size: 0.875em !important;
				color: theme('colors.accent.coral') !important;
			}
			.prose pre {
				background: theme('colors.background.light') !important;
				padding: 1rem !important;
				border-radius: 0.5rem !important;
				overflow-x: auto !important;
				margin: 1.5rem 0 !important;
			}
			.prose pre code {
				background: transparent !important;
				color: theme('colors.text.DEFAULT') !important;
				padding: 0 !important;
			}
			/* AdSense 광고 스타일링 */
			.ad-container {
				min-height: 250px;
				background: theme('colors.background.light');
				border: 1px dashed theme('colors.background.lighter');
				border-radius: 8px;
				padding: 16px;
				margin-bottom: 20px;
				display: flex;
				align-items: center;
				justify-content: center;
				position: relative;
			}
			.ad-container::before {
				content: '광고';
				position: absolute;
				top: 8px;
				left: 12px;
				font-size: 11px;
				color: theme('colors.text.DEFAULT');
				background: theme('colors.background.DEFAULT');
				padding: 2px 6px;
				border-radius: 3px;
			}
			.adsbygoogle {
				min-height: 250px;
				width: 100%;
			}
		</style>
	</head>

	<body class="min-h-screen flex flex-col m-0">
		<Header />
		<main class="flex-1 w-full p-4">
			<div class="flex flex-col md:flex-row max-w-screen-xl mx-auto gap-4">
				<article class="md:w-3/4">
					<div class="prose prose-xl">
						<div class="title mb-4 py-4 text-center leading-none">
							{created_date && (
												<div class="date mb-2 text-text">
					<FormattedDate date={created_date} />
					{updated_date && updated_date > created_date && (
						<span> (Updated: <FormattedDate date={updated_date} />)</span>
					)}
				</div>
			)}
			<h1 class="m-0 mb-2 text-3xl md:text-4xl font-bold text-text">{title}</h1>
			{subtitle && <div class="subtitle text-xl text-text mb-4">{subtitle}</div>}
							{safeTags.length > 0 && (
								<div class="tags flex flex-wrap gap-2 my-4 justify-center">
									{safeTags.map((tag: string) => (
										<a href={getUrl(`/tag/${tag}/`)} class="tag bg-background-light text-text px-3 py-0.5 rounded-full text-sm no-underline transition-all duration-200 hover:bg-primary hover:text-background hover:-translate-y-px">#{tag}</a>
									))}
								</div>
							)}
							{featured_image && typeof featured_image === 'string' && (
								<div class="hero-image w-full">
									<img
										width={1020}
										height={510}
										src={featured_image}
										alt={featured_image_alt || ''}
										class="block mx-auto rounded-xl shadow"
									/>
								</div>
							)}
						</div>
						<slot />
						
						<!-- 댓글 섹션 -->
						<Comments postSlug={postSlug} />
					</div>
				</article>
				<div class="md:w-1/4">
					<div class="sticky top-4">
						<!-- Responsive AdSense Ad Unit -->
						<div class="ad-container">
							<ins class="adsbygoogle"
								 style="display:block"
								 data-ad-client="ca-pub-4653332352131854"
								 data-ad-slot="2433987375"
								 data-ad-format="auto"
								 data-full-width-responsive="true"></ins>
							<script>
								(window.adsbygoogle = window.adsbygoogle || []).push({});
							</script>
						</div>
						
						<!-- 추가 광고 영역 (필요시) -->
						<div class="ad-container mt-4">
							<ins class="adsbygoogle"
								 style="display:block"
								 data-ad-client="ca-pub-4653332352131854"
								 data-ad-slot="2433987375"
								 data-ad-format="auto"
								 data-full-width-responsive="true"></ins>
							<script>
								(window.adsbygoogle = window.adsbygoogle || []).push({});
							</script>
						</div>
					</div>
				</div>
			</div>
		</main>
		<Footer />
		<script>
			import mermaid from 'mermaid';
			document.addEventListener('astro:page-load', () => {
				mermaid.initialize({ 
					startOnLoad: true,
					theme: 'default'
				});
			});
		</script>
	</body>
</html>