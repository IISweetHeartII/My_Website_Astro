---
import type { CollectionEntry } from "astro:content";
import BaseHead from "@/components/layout/BaseHead.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import FormattedDate from "@/components/ui/FormattedDate.astro";
import { getUrl } from "@/utils/url";
import GoogleAnalytics from "@/components/seo/GoogleAnalytics.astro";
import GiscusComments from "@/components/comments/GiscusComments.astro";
import ResponsiveBlogImage from "@/components/ui/ResponsiveBlogImage.astro";
import NewsletterForm from "@/components/newsletter/NewsletterForm.astro";
import FAQSchema from "@/components/seo/FAQSchema.astro";
import { ViewTransitions } from "astro:transitions";
import { SITE_AUTHOR, AUTHOR_GITHUB, AUTHOR_LINKEDIN, SITE_TITLE, SITE_URL } from "@/consts";

interface Props extends Pick<CollectionEntry<"blog">, "data"> {}

const {
  data: {
    title,
    subtitle,
    description = "",
    created_date,
    updated_date,
    featured_image,
    featured_image_alt,
    tags = [],
    meta_title,
    meta_description,
    canonical_url,
    og_title,
    og_description,
    og_image,
    og_type,
    twitter_title,
    twitter_description,
    twitter_image,
    twitter_card,
    keywords,
    author,
    no_index,
    faq,
  },
} = Astro.props;

const safeTags = tags ?? [];

// Ìè¨Ïä§Ìä∏ slug Ï∂îÏ∂ú (URL Í≤ΩÎ°úÏóêÏÑú)
const postSlug = Astro.url.pathname.replace("/blog/", "").replace("/", "") || "unknown";

// JSON-LD Schema ÏÉùÏÑ±
const blogPostSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description: description,
  image: featured_image ? [featured_image] : undefined,
  author: {
    "@type": "Person",
    name: author || SITE_AUTHOR,
    url: `${SITE_URL}/who-is-dh`,
    sameAs: [AUTHOR_GITHUB, AUTHOR_LINKEDIN],
  },
  publisher: {
    "@type": "Organization",
    name: SITE_TITLE,
    url: SITE_URL,
    logo: {
      "@type": "ImageObject",
      url: "https://log8.kr/favicon.svg",
    },
  },
  datePublished: created_date?.toISOString(),
  dateModified: updated_date?.toISOString() || created_date?.toISOString(),
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `https://log8.kr/blog/${postSlug}`,
  },
  keywords: safeTags.join(", "),
  articleSection: safeTags[0] || "Blog",
  inLanguage: "ko-KR",
  url: `https://log8.kr/blog/${postSlug}`,
  speakable: {
    "@type": "SpeakableSpecification",
    cssSelector: [".prose h1", ".prose h2", ".prose > p:first-of-type"],
  },
};
---

<html lang="ko">
  <head>
    <GoogleAnalytics />
    <BaseHead
      title={title ?? ""}
      description={description ?? ""}
      featured_image={featured_image ?? ""}
      featured_image_alt={featured_image_alt ?? ""}
      meta_title={meta_title ?? ""}
      meta_description={meta_description ?? ""}
      canonical_url={canonical_url ?? ""}
      og_title={og_title ?? ""}
      og_description={og_description ?? ""}
      og_image={og_image ?? ""}
      og_type={og_type ?? ""}
      twitter_title={twitter_title ?? ""}
      twitter_description={twitter_description ?? ""}
      twitter_image={twitter_image ?? ""}
      twitter_card={twitter_card ?? ""}
      keywords={[...safeTags, ...(keywords || [])]}
      author={author ?? ""}
      no_index={no_index}
    />
    <ViewTransitions />

    <!-- SEO Structured Data (JSON-LD) - AEO Optimized -->
    <script type="application/ld+json" is:inline set:text={JSON.stringify(blogPostSchema)} />

    <!-- FAQ Schema for AEO (Answer Engine Optimization) -->
    {faq && <FAQSchema faq={faq} />}

    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4653332352131854"
      crossorigin="anonymous"></script>
    <style>
      :global(.mermaid) {
        background: rgb(248, 250, 252);
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
      }
      /* Force prose content to take full width */
      .prose {
        max-width: none !important;
        width: 100%;
      }
      /* ÎßàÌÅ¨Îã§Ïö¥ Í∞ïÏ°∞ ÌëúÏãú Ïä§ÌÉÄÏùºÎßÅ */
      .prose strong,
      .prose b {
        font-weight: 700 !important;
        color: var(--color-text) !important;
      }
      .prose em,
      .prose i {
        font-style: italic !important;
      }
      /* Ï∂îÍ∞ÄÏ†ÅÏù∏ ÎßàÌÅ¨Îã§Ïö¥ Ïä§ÌÉÄÏùºÎßÅ */
      .prose h1,
      .prose h2,
      .prose h3,
      .prose h4,
      .prose h5,
      .prose h6 {
        font-weight: 700 !important;
        color: var(--color-text) !important;
        margin-top: 2rem !important;
        margin-bottom: 1rem !important;
      }
      .prose blockquote {
        border-left: 4px solid var(--color-accent) !important;
        padding-left: 1rem !important;
        margin: 1.5rem 0 !important;
        font-style: italic !important;
        background: var(--color-background-light) !important;
        padding: 1rem !important;
        border-radius: 0.5rem !important;
      }
      .prose code {
        background: var(--color-background-lighter) !important;
        padding: 0.125rem 0.25rem !important;
        border-radius: 0.25rem !important;
        font-size: 0.875em !important;
        color: var(--color-accent-coral) !important;
      }
      .prose pre {
        background: var(--color-background-light) !important;
        padding: 1rem !important;
        border-radius: 0.5rem !important;
        overflow-x: auto !important;
        margin: 1.5rem 0 !important;
      }
      .prose pre code {
        background: transparent !important;
        color: var(--color-text) !important;
        padding: 0 !important;
      }
      /* AdSense Í¥ëÍ≥† Ïä§ÌÉÄÏùºÎßÅ */
      .ad-container {
        min-height: 250px;
        background: var(--color-background-light);
        border: 1px dashed var(--color-background-lighter);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .ad-container::before {
        content: "Í¥ëÍ≥†";
        position: absolute;
        top: 8px;
        left: 12px;
        font-size: 11px;
        color: var(--color-text);
        background: var(--color-background);
        padding: 2px 6px;
        border-radius: 3px;
      }
      .adsbygoogle {
        min-height: 250px;
        width: 100%;
      }
    </style>
  </head>

  <body class="min-h-screen flex flex-col m-0">
    <Header />
    <main class="flex-1 w-full p-4">
      <div class="flex flex-col md:flex-row max-w-7xl mx-auto gap-4">
        <article class="md:w-3/4">
          <div class="prose prose-xl">
            <div class="title mb-4 py-4 text-center leading-none">
              {
                created_date && (
                  <div class="date mb-2 text-text">
                    <FormattedDate date={created_date} />
                    {updated_date && updated_date > created_date && (
                      <span>
                        {" "}
                        (Updated: <FormattedDate date={updated_date} />)
                      </span>
                    )}
                  </div>
                )
              }
              <h1 class="m-0 mb-2 text-3xl md:text-4xl font-bold text-text">{title}</h1>
              {subtitle && <div class="subtitle text-xl text-text mb-4">{subtitle}</div>}
              {
                safeTags.length > 0 && (
                  <div class="tags flex flex-wrap gap-2 my-4 justify-center">
                    {safeTags.map((tag: string) => (
                      <a
                        href={getUrl(`/tag/${tag}/`)}
                        class="tag bg-background-light text-text px-3 py-0.5 rounded-full text-sm no-underline transition-all duration-200 hover:bg-primary hover:text-background hover:-translate-y-px"
                      >
                        #{tag}
                      </a>
                    ))}
                  </div>
                )
              }
              {
                featured_image && typeof featured_image === "string" && (
                  <ResponsiveBlogImage
                    src={featured_image}
                    alt={featured_image_alt || title || "Î∏îÎ°úÍ∑∏ Ìè¨Ïä§Ìä∏ Ïù¥ÎØ∏ÏßÄ"}
                    width={1200}
                    height={675}
                    loading="eager"
                    class="featured-image"
                  />
                )
              }
            </div>
            <slot />

            <!-- Îâ¥Ïä§Î†àÌÑ∞ Íµ¨ÎèÖ Ìèº -->
            <NewsletterForm />

            <!-- ÎåìÍ∏Ä ÏÑπÏÖò -->
            <div class="comments-section mt-12 pt-8 border-t border-background-lighter">
              <h3 class="text-2xl font-bold text-text mb-6 text-center">üí¨ ÎåìÍ∏Ä</h3>
              <GiscusComments />
            </div>
          </div>
        </article>
        <div class="md:w-1/4">
          <div class="sticky top-4">
            <!-- Responsive AdSense Ad Unit -->
            <div class="ad-container">
              <ins
                class="adsbygoogle"
                style="display:block"
                data-ad-client="ca-pub-4653332352131854"
                data-ad-slot="2433987375"
                data-ad-format="auto"
                data-full-width-responsive="true"></ins>
              <script>
                (window.adsbygoogle = window.adsbygoogle || []).push({});
              </script>
            </div>

            <!-- Ï∂îÍ∞Ä Í¥ëÍ≥† ÏòÅÏó≠ (ÌïÑÏöîÏãú) -->
            <div class="ad-container mt-4">
              <ins
                class="adsbygoogle"
                style="display:block"
                data-ad-client="ca-pub-4653332352131854"
                data-ad-slot="2433987375"
                data-ad-format="auto"
                data-full-width-responsive="true"></ins>
              <script>
                (window.adsbygoogle = window.adsbygoogle || []).push({});
              </script>
            </div>
          </div>
        </div>
      </div>
    </main>
    <Footer />
    <script>
      import mermaid from "mermaid";

      // Astro View Transitions ÏßÄÏõê
      document.addEventListener("astro:page-load", () => {
        // mermaid ÏΩîÎìú Î∏îÎ°ùÏùÑ mermaidÍ∞Ä Ïù∏ÏãùÌï† Ïàò ÏûàÎäî ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
        const mermaidBlocks = document.querySelectorAll("code.language-mermaid");
        mermaidBlocks.forEach((block) => {
          const pre = block.parentElement;
          if (pre && pre.tagName === "PRE") {
            const div = document.createElement("div");
            div.className = "mermaid";
            div.textContent = block.textContent || "";
            pre.replaceWith(div);
          }
        });

        // Mermaid Ï¥àÍ∏∞Ìôî Î∞è Î†åÎçîÎßÅ
        mermaid.initialize({
          startOnLoad: true,
          theme: "default",
        });
        mermaid.run();
      });
    </script>
  </body>
</html>
