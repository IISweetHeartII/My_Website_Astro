---
import type { CollectionEntry } from "astro:content";
import type { MarkdownHeading } from "astro";
import { BookOpen } from "lucide-astro";
import RelatedPosts from "@/features/blog/components/RelatedPosts.astro";
import SeriesNavigation from "@/features/blog/components/SeriesNavigation.astro";
import SocialShare from "@/features/blog/components/SocialShare.astro";
import TableOfContents from "@/features/blog/components/TableOfContents.astro";
import GiscusComments from "@/shared/components/comments/GiscusComments.astro";
import BreadcrumbSchema from "@/shared/components/seo/BreadcrumbSchema.astro";
import FAQSchema from "@/shared/components/seo/FAQSchema.astro";
import FAQItem from "@/shared/components/ui/FAQItem.astro";
import FormattedDate from "@/shared/components/ui/FormattedDate.astro";
import ResponsiveBlogImage from "@/shared/components/ui/ResponsiveBlogImage.astro";
import {
  AUTHOR_GITHUB,
  AUTHOR_LINKEDIN,
  SITE_AUTHOR,
  SITE_TITLE,
  SITE_URL,
} from "@/shared/config/consts";
import { getUrl } from "@/shared/utils/url";
import Layout from "./Layout.astro";

interface Props extends Pick<CollectionEntry<"blog">, "data"> {
  readingTime?: number;
  headings?: MarkdownHeading[];
  relatedPosts?: CollectionEntry<"blog">[];
  currentPost?: CollectionEntry<"blog">;
  seriesPosts?: CollectionEntry<"blog">[];
}

const {
  data: {
    title,
    subtitle,
    description = "",
    created_date,
    updated_date,
    featured_image,
    featured_image_alt,
    tags = [],
    meta_title,
    meta_description,
    canonical_url,
    og_title,
    og_description,
    og_image,
    og_type,
    twitter_title,
    twitter_description,
    twitter_image,
    twitter_card,
    keywords,
    author,
    no_index,
    faq,
  },
  readingTime,
  headings = [],
  relatedPosts = [],
  currentPost,
  seriesPosts = [],
} = Astro.props;

const safeTags = tags ?? [];

// 포스트 slug 추출 (URL 경로에서)
const postSlug = Astro.url.pathname.replace("/blog/", "").replace("/", "") || "unknown";

// OG image fallback: if no explicit og_image, default to /og/{slug}.png
const resolvedOgImage = og_image || `/og/${postSlug}.png`;

// Full post URL for sharing
const postUrl = `${SITE_URL}/blog/${postSlug}`;

// JSON-LD Schema 생성 (Entity-first with stable @id)
const blogPostSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "@id": `${postUrl}/#article`,
  headline: title,
  description: description,
  image: featured_image ? [featured_image] : undefined,
  author: {
    "@type": "Person",
    "@id": `${SITE_URL}/#author`,
    name: author || SITE_AUTHOR,
    url: `${SITE_URL}/portfolio`,
    sameAs: [AUTHOR_GITHUB, AUTHOR_LINKEDIN],
  },
  publisher: {
    "@type": "Organization",
    "@id": `${SITE_URL}/#publisher`,
    name: SITE_TITLE,
    url: SITE_URL,
    logo: {
      "@type": "ImageObject",
      url: `${SITE_URL}/images/design/icon.png`,
    },
  },
  isPartOf: { "@id": `${SITE_URL}/#website` },
  datePublished: created_date?.toISOString(),
  dateModified: updated_date?.toISOString() || created_date?.toISOString(),
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": postUrl,
  },
  keywords: safeTags.join(", "),
  articleSection: safeTags[0] || "Blog",
  inLanguage: "ko-KR",
  url: postUrl,
  speakable: {
    "@type": "SpeakableSpecification",
    cssSelector: [".prose h1", ".prose h2", ".prose > p:first-of-type"],
  },
};
---

<Layout title={title ?? ""} description={description ?? ""}>
  <Fragment slot="head">
    <!-- BlogPost 전용 SEO 메타태그 -->
    <meta property="og:type" content={og_type || "article"} />
    <meta property="article:published_time" content={created_date?.toISOString()} />
    {updated_date && <meta property="article:modified_time" content={updated_date.toISOString()} />}
    {author && <meta property="article:author" content={author} />}
    {safeTags.map((tag: string) => <meta property="article:tag" content={tag} />)}

    <meta property="og:image" content={resolvedOgImage} />
    {featured_image_alt && <meta property="og:image:alt" content={featured_image_alt} />}

    {meta_title && <meta name="title" content={meta_title} />}
    {meta_description && <meta name="description" content={meta_description} />}
    {canonical_url && <link rel="canonical" href={canonical_url} />}

    {og_title && <meta property="og:title" content={og_title} />}
    {og_description && <meta property="og:description" content={og_description} />}

    {twitter_title && <meta name="twitter:title" content={twitter_title} />}
    {twitter_description && <meta name="twitter:description" content={twitter_description} />}
    {twitter_image && <meta name="twitter:image" content={twitter_image} />}
    {twitter_card && <meta name="twitter:card" content={twitter_card} />}

    {keywords && keywords.map((keyword: string) => <meta name="keywords" content={keyword} />)}
    {no_index && <meta name="robots" content="noindex, nofollow" />}

    <!-- SEO Structured Data (JSON-LD) - AEO Optimized -->
    <script type="application/ld+json" is:inline set:text={JSON.stringify(blogPostSchema)} />

    <!-- BreadcrumbList Schema -->
    <BreadcrumbSchema items={[
      { name: "홈", url: "/" },
      { name: "블로그", url: "/blog/" },
      { name: title ?? "글", url: `/blog/${postSlug}/` },
    ]} />

    <!-- FAQ Schema for AEO (Answer Engine Optimization) -->
    {faq && <FAQSchema faq={faq} />}

    <!-- BlogPost 전용 스타일 -->
    <style>
      /* Mermaid 다이어그램 스타일 */
      :global(.mermaid) {
        background: var(--color-background-light);
        border: 1px solid var(--color-background-lighter);
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
      }

      /* BlogPost 레이아웃: prose를 전체 너비로 확장 */
      .prose {
        max-width: none !important;
        width: 100%;
      }
    </style>
  </Fragment>

  <!-- BlogPost 본문 콘텐츠 -->
  <div class="w-full p-4">
    <div class="flex flex-col lg:flex-row max-w-7xl mx-auto gap-8">
      <article class="flex-1 min-w-0" data-pagefind-body>
        <!-- 제목, 날짜, 읽기 시간, 태그, 이미지 섹션 (prose 밖) -->
        <div class="title mb-4 py-4 text-center leading-none">
          {
            created_date && (
              <div class="date mb-2 text-text flex items-center justify-center gap-2 flex-wrap">
                <FormattedDate date={created_date} />
                {updated_date && updated_date > created_date && (
                  <span>
                    (Updated: <FormattedDate date={updated_date} />)
                  </span>
                )}
                {readingTime && (
                  <span class="inline-flex items-center gap-1 text-text/70">
                    <BookOpen class="w-4 h-4" />
                    {readingTime}분 읽기
                  </span>
                )}
              </div>
            )
          }
          <h1 class="m-0 mb-2 text-3xl md:text-4xl font-bold text-text">{title}</h1>
          {subtitle && <div class="subtitle text-xl text-text mb-4">{subtitle}</div>}
          {
            safeTags.length > 0 && (
              <div class="tags flex flex-wrap gap-2 my-4 justify-center">
                {safeTags.map((tag: string) => (
                  <a
                     href={getUrl(`/tag/${tag}/`)}
                     class="tag bg-background-light text-text px-3 py-0.5 rounded-full text-sm no-underline transition-all duration-200 hover:bg-primary hover:text-on-primary hover:-translate-y-px"
                   >
                    #{tag}
                  </a>
                ))}
              </div>
            )
          }
          {
            featured_image && typeof featured_image === "string" && (
              <ResponsiveBlogImage
                src={featured_image}
                alt={featured_image_alt || title || "블로그 포스트 이미지"}
                width={1200}
                height={675}
                loading="eager"
                class="featured-image"
              />
            )
          }
        </div>

        <!-- Series Navigation (before prose content) -->
        {currentPost && seriesPosts.length > 1 && (
          <SeriesNavigation currentPost={currentPost} seriesPosts={seriesPosts} />
        )}

        <!-- Mobile TOC (before prose content) -->
        <TableOfContents headings={headings} />

        <!-- 실제 블로그 콘텐츠만 prose로 감싸기 -->
        <div class="prose prose-xl">
          <slot />
        </div>

        <!-- Social Share -->
        <SocialShare title={title ?? ""} url={postUrl} description={description ?? ""} />

        <!-- FAQ Section (AEO - Answer Engine Optimization) -->
        {
          faq && faq.length > 0 && (
            <section class="faq-section mt-12 pt-8 border-t border-background-lighter">
              <h2 class="text-2xl font-bold text-text mb-6 text-center">
                자주 묻는 질문
              </h2>
              <div class="max-w-3xl mx-auto bg-background-light rounded-xl p-6">
                {faq.map((item: { question: string; answer: string }, index: number) => (
                  <FAQItem
                    question={item.question}
                    answer={item.answer}
                    delay={index * 0.1}
                  />
                ))}
              </div>
            </section>
          )
        }

        <!-- Related Posts -->
        <RelatedPosts posts={relatedPosts} />

        <!-- 댓글 섹션 (prose 밖) -->
        <div class="comments-section mt-12 pt-8 border-t border-background-lighter">
          <h3 class="text-2xl font-bold text-text mb-6 text-center">댓글</h3>
          <GiscusComments />
        </div>
      </article>

      <!-- Desktop TOC sidebar -->
      <TableOfContents headings={headings} />
    </div>
  </div>

  <!-- Mermaid 다이어그램 스크립트 -->
  <script>
    import mermaid from "mermaid";

    // Astro View Transitions 지원
    document.addEventListener("astro:page-load", () => {
      // mermaid 코드 블록을 mermaid가 인식할 수 있는 형식으로 변환
      const mermaidBlocks = document.querySelectorAll("code.language-mermaid");
      mermaidBlocks.forEach((block) => {
        const pre = block.parentElement;
        if (pre && pre.tagName === "PRE") {
          const div = document.createElement("div");
          div.className = "mermaid";
          div.textContent = block.textContent || "";
          pre.replaceWith(div);
        }
      });

      // Mermaid 초기화 및 렌더링
      const themeKey = "theme";
      const isDark = document.documentElement.dataset[themeKey] === "dark";

      mermaid.initialize({
        startOnLoad: true,
        theme: isDark ? "dark" : "default",
      });
      mermaid.run();
    });
  </script>
</Layout>
