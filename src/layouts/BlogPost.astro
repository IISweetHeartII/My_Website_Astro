---
import type { CollectionEntry } from "astro:content";
import GiscusComments from "@/shared/components/comments/GiscusComments.astro";
import FAQSchema from "@/shared/components/seo/FAQSchema.astro";
import FAQItem from "@/shared/components/ui/FAQItem.astro";
import FormattedDate from "@/shared/components/ui/FormattedDate.astro";
import ResponsiveBlogImage from "@/shared/components/ui/ResponsiveBlogImage.astro";
import {
  AUTHOR_GITHUB,
  AUTHOR_LINKEDIN,
  SITE_AUTHOR,
  SITE_TITLE,
  SITE_URL,
} from "@/shared/config/consts";
import { getUrl } from "@/shared/utils/url";
import Layout from "./Layout.astro";

interface Props extends Pick<CollectionEntry<"blog">, "data"> {}

const {
  data: {
    title,
    subtitle,
    description = "",
    created_date,
    updated_date,
    featured_image,
    featured_image_alt,
    tags = [],
    meta_title,
    meta_description,
    canonical_url,
    og_title,
    og_description,
    og_image,
    og_type,
    twitter_title,
    twitter_description,
    twitter_image,
    twitter_card,
    keywords,
    author,
    no_index,
    faq,
  },
} = Astro.props;

const safeTags = tags ?? [];

// í¬ìŠ¤íŠ¸ slug ì¶”ì¶œ (URL ê²½ë¡œì—ì„œ)
const postSlug = Astro.url.pathname.replace("/blog/", "").replace("/", "") || "unknown";

// JSON-LD Schema ìƒì„±
const blogPostSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description: description,
  image: featured_image ? [featured_image] : undefined,
  author: {
    "@type": "Person",
    name: author || SITE_AUTHOR,
    url: `${SITE_URL}/portfolio`,
    sameAs: [AUTHOR_GITHUB, AUTHOR_LINKEDIN],
  },
  publisher: {
    "@type": "Organization",
    name: SITE_TITLE,
    url: SITE_URL,
    logo: {
      "@type": "ImageObject",
      url: "https://log8.kr/favicon.svg",
    },
  },
  datePublished: created_date?.toISOString(),
  dateModified: updated_date?.toISOString() || created_date?.toISOString(),
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `https://log8.kr/blog/${postSlug}`,
  },
  keywords: safeTags.join(", "),
  articleSection: safeTags[0] || "Blog",
  inLanguage: "ko-KR",
  url: `https://log8.kr/blog/${postSlug}`,
  speakable: {
    "@type": "SpeakableSpecification",
    cssSelector: [".prose h1", ".prose h2", ".prose > p:first-of-type"],
  },
};
---

<Layout title={title ?? ""} description={description ?? ""}>
  <Fragment slot="head">
    <!-- BlogPost ì „ìš© SEO ë©”íƒ€íƒœê·¸ -->
    <meta property="og:type" content={og_type || "article"} />
    <meta property="article:published_time" content={created_date?.toISOString()} />
    {updated_date && <meta property="article:modified_time" content={updated_date.toISOString()} />}
    {author && <meta property="article:author" content={author} />}
    {safeTags.map((tag: string) => <meta property="article:tag" content={tag} />)}

    {featured_image && <meta property="og:image" content={featured_image} />}
    {featured_image_alt && <meta property="og:image:alt" content={featured_image_alt} />}

    {meta_title && <meta name="title" content={meta_title} />}
    {meta_description && <meta name="description" content={meta_description} />}
    {canonical_url && <link rel="canonical" href={canonical_url} />}

    {og_title && <meta property="og:title" content={og_title} />}
    {og_description && <meta property="og:description" content={og_description} />}
    {og_image && <meta property="og:image" content={og_image} />}

    {twitter_title && <meta name="twitter:title" content={twitter_title} />}
    {twitter_description && <meta name="twitter:description" content={twitter_description} />}
    {twitter_image && <meta name="twitter:image" content={twitter_image} />}
    {twitter_card && <meta name="twitter:card" content={twitter_card} />}

    {keywords && keywords.map((keyword: string) => <meta name="keywords" content={keyword} />)}
    {no_index && <meta name="robots" content="noindex, nofollow" />}

    <!-- SEO Structured Data (JSON-LD) - AEO Optimized -->
    <script type="application/ld+json" is:inline set:text={JSON.stringify(blogPostSchema)} />

    <!-- FAQ Schema for AEO (Answer Engine Optimization) -->
    {faq && <FAQSchema faq={faq} />}

    <!-- BlogPost ì „ìš© ìŠ¤íƒ€ì¼ -->
    <style>
      /* Mermaid ë‹¤ì´ì–´ê·¸ë¨ ìŠ¤íƒ€ì¼ */
      :global(.mermaid) {
        background: var(--color-background-light);
        border: 1px solid var(--color-background-lighter);
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
      }

      /* BlogPost ë ˆì´ì•„ì›ƒ: proseë¥¼ ì „ì²´ ë„ˆë¹„ë¡œ í™•ì¥ */
      .prose {
        max-width: none !important;
        width: 100%;
      }
    </style>
  </Fragment>

  <!-- BlogPost ë³¸ë¬¸ ì½˜í…ì¸  -->
  <div class="w-full p-4">
    <div class="flex flex-col md:flex-row max-w-7xl mx-auto gap-4">
      <article class="w-full">
        <!-- ì œëª©, ë‚ ì§œ, íƒœê·¸, ì´ë¯¸ì§€ ì„¹ì…˜ (prose ë°–) -->
        <div class="title mb-4 py-4 text-center leading-none">
          {
            created_date && (
              <div class="date mb-2 text-text">
                <FormattedDate date={created_date} />
                {updated_date && updated_date > created_date && (
                  <span>
                    {" "}
                    (Updated: <FormattedDate date={updated_date} />)
                  </span>
                )}
              </div>
            )
          }
          <h1 class="m-0 mb-2 text-3xl md:text-4xl font-bold text-text">{title}</h1>
          {subtitle && <div class="subtitle text-xl text-text mb-4">{subtitle}</div>}
          {
            safeTags.length > 0 && (
              <div class="tags flex flex-wrap gap-2 my-4 justify-center">
                {safeTags.map((tag: string) => (
                  <a
                     href={getUrl(`/tag/${tag}/`)}
                     class="tag bg-background-light text-text px-3 py-0.5 rounded-full text-sm no-underline transition-all duration-200 hover:bg-primary hover:text-on-primary hover:-translate-y-px"
                   >
                    #{tag}
                  </a>
                ))}
              </div>
            )
          }
          {
            featured_image && typeof featured_image === "string" && (
              <ResponsiveBlogImage
                src={featured_image}
                alt={featured_image_alt || title || "ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€"}
                width={1200}
                height={675}
                loading="eager"
                class="featured-image"
              />
            )
          }
        </div>

        <!-- ì‹¤ì œ ë¸”ë¡œê·¸ ì½˜í…ì¸ ë§Œ proseë¡œ ê°ì‹¸ê¸° -->
        <div class="prose prose-xl">
          <slot />
        </div>

        <!-- FAQ Section (AEO - Answer Engine Optimization) -->
        {
          faq && faq.length > 0 && (
            <section class="faq-section mt-12 pt-8 border-t border-background-lighter">
              <h2 class="text-2xl font-bold text-text mb-6 text-center">
                ìì£¼ ë¬»ëŠ” ì§ˆë¬¸
              </h2>
              <div class="max-w-3xl mx-auto bg-background-light rounded-xl p-6">
                {faq.map((item: { question: string; answer: string }, index: number) => (
                  <FAQItem
                    question={item.question}
                    answer={item.answer}
                    delay={index * 0.1}
                  />
                ))}
              </div>
            </section>
          )
        }

        <!-- ëŒ“ê¸€ ì„¹ì…˜ (prose ë°–) -->
        <div class="comments-section mt-12 pt-8 border-t border-background-lighter">
          <h3 class="text-2xl font-bold text-text mb-6 text-center">ğŸ’¬ ëŒ“ê¸€</h3>
          <GiscusComments />
        </div>
      </article>
    </div>
  </div>

  <!-- Mermaid ë‹¤ì´ì–´ê·¸ë¨ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    import mermaid from "mermaid";

    // Astro View Transitions ì§€ì›
    document.addEventListener("astro:page-load", () => {
      // mermaid ì½”ë“œ ë¸”ë¡ì„ mermaidê°€ ì¸ì‹í•  ìˆ˜ ìˆëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const mermaidBlocks = document.querySelectorAll("code.language-mermaid");
      mermaidBlocks.forEach((block) => {
        const pre = block.parentElement;
        if (pre && pre.tagName === "PRE") {
          const div = document.createElement("div");
          div.className = "mermaid";
          div.textContent = block.textContent || "";
          pre.replaceWith(div);
        }
      });

      // Mermaid ì´ˆê¸°í™” ë° ë Œë”ë§
      const themeKey = "theme";
      const isDark = document.documentElement.dataset[themeKey] === "dark";

      mermaid.initialize({
        startOnLoad: true,
        theme: isDark ? "dark" : "default",
      });
      mermaid.run();
    });
  </script>
</Layout>
