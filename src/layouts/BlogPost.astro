---
import type { CollectionEntry } from "astro:content";
import BaseHead from "@/shared/components/layout/BaseHead.astro";
import Header from "@/shared/components/layout/Header.astro";
import Footer from "@/shared/components/layout/Footer.astro";
import FormattedDate from "@/shared/components/ui/FormattedDate.astro";
import { getUrl } from "@/shared/utils/url";
import GoogleAnalytics from "@/shared/components/seo/GoogleAnalytics.astro";
import GiscusComments from "@/shared/components/comments/GiscusComments.astro";
import ResponsiveBlogImage from "@/shared/components/ui/ResponsiveBlogImage.astro";
import NewsletterForm from "@/features/newsletter/components/NewsletterForm.astro";
import FAQSchema from "@/shared/components/seo/FAQSchema.astro";
import {
  SITE_AUTHOR,
  AUTHOR_GITHUB,
  AUTHOR_LINKEDIN,
  SITE_TITLE,
  SITE_URL,
} from "@/shared/config/consts";
import "@/styles/theme.css";

interface Props extends Pick<CollectionEntry<"blog">, "data"> {}

const {
  data: {
    title,
    subtitle,
    description = "",
    created_date,
    updated_date,
    featured_image,
    featured_image_alt,
    tags = [],
    meta_title,
    meta_description,
    canonical_url,
    og_title,
    og_description,
    og_image,
    og_type,
    twitter_title,
    twitter_description,
    twitter_image,
    twitter_card,
    keywords,
    author,
    no_index,
    faq,
  },
} = Astro.props;

const safeTags = tags ?? [];

// Ìè¨Ïä§Ìä∏ slug Ï∂îÏ∂ú (URL Í≤ΩÎ°úÏóêÏÑú)
const postSlug = Astro.url.pathname.replace("/blog/", "").replace("/", "") || "unknown";

// JSON-LD Schema ÏÉùÏÑ±
const blogPostSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description: description,
  image: featured_image ? [featured_image] : undefined,
  author: {
    "@type": "Person",
    name: author || SITE_AUTHOR,
    url: `${SITE_URL}/who-is-dh`,
    sameAs: [AUTHOR_GITHUB, AUTHOR_LINKEDIN],
  },
  publisher: {
    "@type": "Organization",
    name: SITE_TITLE,
    url: SITE_URL,
    logo: {
      "@type": "ImageObject",
      url: "https://log8.kr/favicon.svg",
    },
  },
  datePublished: created_date?.toISOString(),
  dateModified: updated_date?.toISOString() || created_date?.toISOString(),
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `https://log8.kr/blog/${postSlug}`,
  },
  keywords: safeTags.join(", "),
  articleSection: safeTags[0] || "Blog",
  inLanguage: "ko-KR",
  url: `https://log8.kr/blog/${postSlug}`,
  speakable: {
    "@type": "SpeakableSpecification",
    cssSelector: [".prose h1", ".prose h2", ".prose > p:first-of-type"],
  },
};
---

<html lang="ko">
  <head>
    <GoogleAnalytics />
    <BaseHead
      title={title ?? ""}
      description={description ?? ""}
      featured_image={featured_image ?? ""}
      featured_image_alt={featured_image_alt ?? ""}
      meta_title={meta_title ?? ""}
      meta_description={meta_description ?? ""}
      canonical_url={canonical_url ?? ""}
      og_title={og_title ?? ""}
      og_description={og_description ?? ""}
      og_image={og_image ?? ""}
      og_type={og_type ?? ""}
      twitter_title={twitter_title ?? ""}
      twitter_description={twitter_description ?? ""}
      twitter_image={twitter_image ?? ""}
      twitter_card={twitter_card ?? ""}
      keywords={[...safeTags, ...(keywords || [])]}
      author={author ?? ""}
      no_index={no_index}
    />

    <!-- SEO Structured Data (JSON-LD) - AEO Optimized -->
    <script type="application/ld+json" is:inline set:text={JSON.stringify(blogPostSchema)} />

    <!-- FAQ Schema for AEO (Answer Engine Optimization) -->
    {faq && <FAQSchema faq={faq} />}

    <style>
      /* Mermaid Îã§Ïù¥Ïñ¥Í∑∏Îû® Ïä§ÌÉÄÏùº */
      :global(.mermaid) {
        background: rgb(248, 250, 252);
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
      }

      /* BlogPost Î†àÏù¥ÏïÑÏõÉ: proseÎ•º Ï†ÑÏ≤¥ ÎÑàÎπÑÎ°ú ÌôïÏû• */
      .prose {
        max-width: none !important;
        width: 100%;
      }

      /* AdSense Í¥ëÍ≥† Ïä§ÌÉÄÏùº */
      .ad-container {
        min-height: 250px;
        background: var(--color-background-light);
        border: 1px dashed var(--color-background-lighter);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .ad-container::before {
        content: "Í¥ëÍ≥†";
        position: absolute;
        top: 8px;
        left: 12px;
        font-size: 11px;
        color: var(--color-text);
        background: var(--color-background);
        padding: 2px 6px;
        border-radius: 3px;
      }
      .adsbygoogle {
        min-height: 250px;
        width: 100%;
      }
    </style>
  </head>

  <body class="min-h-screen flex flex-col m-0">
    <Header />
    <main class="flex-1 w-full p-4">
      <div class="flex flex-col md:flex-row max-w-7xl mx-auto gap-4">
        <article class="md:w-3/4">
          <!-- Ï†úÎ™©, ÎÇ†Ïßú, ÌÉúÍ∑∏, Ïù¥ÎØ∏ÏßÄ ÏÑπÏÖò (prose Î∞ñ) -->
          <div class="title mb-4 py-4 text-center leading-none">
            {
              created_date && (
                <div class="date mb-2 text-text">
                  <FormattedDate date={created_date} />
                  {updated_date && updated_date > created_date && (
                    <span>
                      {" "}
                      (Updated: <FormattedDate date={updated_date} />)
                    </span>
                  )}
                </div>
              )
            }
            <h1 class="m-0 mb-2 text-3xl md:text-4xl font-bold text-text">{title}</h1>
            {subtitle && <div class="subtitle text-xl text-text mb-4">{subtitle}</div>}
            {
              safeTags.length > 0 && (
                <div class="tags flex flex-wrap gap-2 my-4 justify-center">
                  {safeTags.map((tag: string) => (
                    <a
                      href={getUrl(`/tag/${tag}/`)}
                      class="tag bg-background-light text-text px-3 py-0.5 rounded-full text-sm no-underline transition-all duration-200 hover:bg-primary hover:text-background hover:-translate-y-px"
                    >
                      #{tag}
                    </a>
                  ))}
                </div>
              )
            }
            {
              featured_image && typeof featured_image === "string" && (
                <ResponsiveBlogImage
                  src={featured_image}
                  alt={featured_image_alt || title || "Î∏îÎ°úÍ∑∏ Ìè¨Ïä§Ìä∏ Ïù¥ÎØ∏ÏßÄ"}
                  width={1200}
                  height={675}
                  loading="eager"
                  class="featured-image"
                />
              )
            }
          </div>

          <!-- Ïã§Ï†ú Î∏îÎ°úÍ∑∏ ÏΩòÌÖêÏ∏†Îßå proseÎ°ú Í∞êÏã∏Í∏∞ -->
          <div class="prose prose-xl">
            <slot />
          </div>

          <!-- In-Article Í¥ëÍ≥† (Î≥∏Î¨∏ ÎÅù) -->
          <div class="ad-container my-8">
            <ins
              class="adsbygoogle"
              style="display:block; text-align:center;"
              data-ad-layout="in-article"
              data-ad-format="fluid"
              data-ad-client="ca-pub-4653332352131854"
              data-ad-slot="1234567890"></ins>
            <script is:inline>
              (window.adsbygoogle = window.adsbygoogle || []).push({});
            </script>
          </div>

          <!-- Îâ¥Ïä§Î†àÌÑ∞ Íµ¨ÎèÖ Ìèº (prose Î∞ñ) -->
          <NewsletterForm />

          <!-- ÎåìÍ∏Ä ÏúÑ Í¥ëÍ≥† -->
          <div class="ad-container my-8">
            <ins
              class="adsbygoogle"
              style="display:block"
              data-ad-format="autorelaxed"
              data-ad-client="ca-pub-4653332352131854"
              data-ad-slot="9876543210"></ins>
            <script is:inline>
              (window.adsbygoogle = window.adsbygoogle || []).push({});
            </script>
          </div>

          <!-- ÎåìÍ∏Ä ÏÑπÏÖò (prose Î∞ñ) -->
          <div class="comments-section mt-12 pt-8 border-t border-background-lighter">
            <h3 class="text-2xl font-bold text-text mb-6 text-center">üí¨ ÎåìÍ∏Ä</h3>
            <GiscusComments />
          </div>
        </article>
        <div class="md:w-1/4">
          <div class="sticky top-4">
            <!-- Responsive AdSense Ad Unit -->
            <div class="ad-container">
              <ins
                class="adsbygoogle"
                style="display:block"
                data-ad-client="ca-pub-4653332352131854"
                data-ad-slot="2433987375"
                data-ad-format="auto"
                data-full-width-responsive="true"></ins>
              <script is:inline>
                (window.adsbygoogle = window.adsbygoogle || []).push({});
              </script>
            </div>
          </div>
        </div>
      </div>
    </main>
    <Footer />
    <script>
      import mermaid from "mermaid";

      // Astro View Transitions ÏßÄÏõê
      document.addEventListener("astro:page-load", () => {
        // mermaid ÏΩîÎìú Î∏îÎ°ùÏùÑ mermaidÍ∞Ä Ïù∏ÏãùÌï† Ïàò ÏûàÎäî ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
        const mermaidBlocks = document.querySelectorAll("code.language-mermaid");
        mermaidBlocks.forEach((block) => {
          const pre = block.parentElement;
          if (pre && pre.tagName === "PRE") {
            const div = document.createElement("div");
            div.className = "mermaid";
            div.textContent = block.textContent || "";
            pre.replaceWith(div);
          }
        });

        // Mermaid Ï¥àÍ∏∞Ìôî Î∞è Î†åÎçîÎßÅ
        mermaid.initialize({
          startOnLoad: true,
          theme: "default",
        });
        mermaid.run();
      });
    </script>
  </body>
</html>
