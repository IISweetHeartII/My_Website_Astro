---
// Giscus Comments Component for Astro
interface Props {
  id?: string;
  className?: string;
}

const { id = "giscus-comments", className = "" } = Astro.props;

// GitHub 저장소 정보 (실제 Giscus 설정값)
const REPO = "IISweetHeartII/My_Website_Astro";
const REPO_ID = "R_kgDOOx8Ylg";
const CATEGORY = "General";
const CATEGORY_ID = "DIC_kwDOOx8Yls4Cvm-Z";

// 현재 페이지 정보
const currentUrl = Astro.url.pathname;
const pageTitle = Astro.url.pathname.replace('/blog/', '').replace('/', '') || 'home';
---

<div
  id={id}
  class={`giscus-container w-full mt-8 mb-4 ${className}`}
>
  <!-- Giscus가 여기에 로드됩니다 -->
</div>

<script define:vars={{ REPO, REPO_ID, CATEGORY, CATEGORY_ID, currentUrl, pageTitle }}>
  function loadGiscus() {
    // 이미 로드된 경우 중복 방지
    if (document.querySelector('iframe.giscus-frame')) {
      return;
    }

    // Giscus 스크립트 동적 생성
    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.async = true;
    script.crossOrigin = 'anonymous';

    // Giscus 설정
    script.setAttribute('data-repo', REPO);
    script.setAttribute('data-repo-id', REPO_ID);
    script.setAttribute('data-category', CATEGORY);
    script.setAttribute('data-category-id', CATEGORY_ID);
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '1');
    script.setAttribute('data-input-position', 'bottom');
    script.setAttribute('data-theme', 'preferred_color_scheme');
    script.setAttribute('data-lang', 'ko');
    script.setAttribute('data-loading', 'lazy');

    // 컨테이너에 스크립트 추가
    const container = document.getElementById('giscus-comments');
    if (container) {
      container.appendChild(script);
    }
  }

  // Intersection Observer를 사용한 성능 최적화 (lazy loading)
  function initGiscusObserver() {
    const container = document.getElementById('giscus-comments');
    if (!container) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            loadGiscus();
            observer.unobserve(entry.target);
          }
        });
      },
      {
        rootMargin: '100px', // 100px 미리 로딩
        threshold: 0.1
      }
    );

    observer.observe(container);
  }

  // Astro 페이지 로드 이벤트에서 초기화
  document.addEventListener('astro:page-load', initGiscusObserver);

  // 첫 로드 시에도 실행
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGiscusObserver);
  } else {
    initGiscusObserver();
  }
</script>

<style>
  .giscus-container {
    /* Pretendard 폰트 적용 */
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  }

  /* Giscus iframe 스타일링 */
  .giscus-container :global(.giscus-frame) {
    width: 100% !important;
    border: none;
    border-radius: 0.5rem;
    background: transparent;
  }

  /* 로딩 상태 스타일 */
  .giscus-container:empty::before {
    content: '💬 댓글을 불러오는 중...';
    display: block;
    text-align: center;
    padding: 2rem;
    color: var(--color-text-light, #6b7280);
    font-size: 0.875rem;
    border: 1px dashed var(--color-background-lighter, #e5e7eb);
    border-radius: 0.5rem;
    background: var(--color-background-light, #f9fafb);
  }

  /* 반응형 디자인 */
  @media (max-width: 768px) {
    .giscus-container {
      margin-top: 1.5rem;
      margin-bottom: 1rem;
    }
  }

  /* 댓글 섹션 헤더 */
  .giscus-container::after {
    content: '';
    display: block;
    width: 100%;
    height: 1px;
    background: linear-gradient(
      to right,
      transparent,
      var(--color-background-lighter, #e5e7eb) 20%,
      var(--color-background-lighter, #e5e7eb) 80%,
      transparent
    );
    margin-bottom: 1rem;
  }
</style>