---
// Giscus Comments Component for Astro
interface Props {
  id?: string;
  className?: string;
}

const { id = "giscus-comments", className = "" } = Astro.props;

// GitHub ì €ì¥ì†Œ ì •ë³´ (ì‹¤ì œ Giscus ì„¤ì •ê°’)
const REPO = "IISweetHeartII/My_Website_Astro";
const REPO_ID = "R_kgDOOx8Ylg";
const CATEGORY = "General";
const CATEGORY_ID = "DIC_kwDOOx8Yls4Cvm-Z";

// í˜„ì¬ í˜ì´ì§€ ì •ë³´
const currentUrl = Astro.url.pathname;
const pageTitle = Astro.url.pathname.replace('/blog/', '').replace('/', '') || 'home';
---

<div
  id={id}
  class={`giscus-container w-full mt-8 mb-4 ${className}`}
>
  <!-- Giscusê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
</div>

<script define:vars={{ REPO, REPO_ID, CATEGORY, CATEGORY_ID, currentUrl, pageTitle }}>
  function loadGiscus() {
    // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¤‘ë³µ ë°©ì§€
    if (document.querySelector('iframe.giscus-frame')) {
      return;
    }

    // Giscus ìŠ¤í¬ë¦½íŠ¸ ë™ì  ìƒì„±
    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.async = true;
    script.crossOrigin = 'anonymous';

    // Giscus ì„¤ì •
    script.setAttribute('data-repo', REPO);
    script.setAttribute('data-repo-id', REPO_ID);
    script.setAttribute('data-category', CATEGORY);
    script.setAttribute('data-category-id', CATEGORY_ID);
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '1');
    script.setAttribute('data-input-position', 'bottom');
    script.setAttribute('data-theme', 'preferred_color_scheme');
    script.setAttribute('data-lang', 'ko');
    script.setAttribute('data-loading', 'lazy');

    // ì»¨í…Œì´ë„ˆì— ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
    const container = document.getElementById('giscus-comments');
    if (container) {
      container.appendChild(script);
    }
  }

  // Intersection Observerë¥¼ ì‚¬ìš©í•œ ì„±ëŠ¥ ìµœì í™” (lazy loading)
  function initGiscusObserver() {
    const container = document.getElementById('giscus-comments');
    if (!container) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            loadGiscus();
            observer.unobserve(entry.target);
          }
        });
      },
      {
        rootMargin: '100px', // 100px ë¯¸ë¦¬ ë¡œë”©
        threshold: 0.1
      }
    );

    observer.observe(container);
  }

  // Astro í˜ì´ì§€ ë¡œë“œ ì´ë²¤íŠ¸ì—ì„œ ì´ˆê¸°í™”
  document.addEventListener('astro:page-load', initGiscusObserver);

  // ì²« ë¡œë“œ ì‹œì—ë„ ì‹¤í–‰
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGiscusObserver);
  } else {
    initGiscusObserver();
  }
</script>

<style>
  .giscus-container {
    /* Pretendard í°íŠ¸ ì ìš© */
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  }

  /* Giscus iframe ìŠ¤íƒ€ì¼ë§ */
  .giscus-container :global(.giscus-frame) {
    width: 100% !important;
    border: none;
    border-radius: 0.5rem;
    background: transparent;
  }

  /* ë¡œë”© ìƒíƒœ ìŠ¤íƒ€ì¼ */
  .giscus-container:empty::before {
    content: 'ğŸ’¬ ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    display: block;
    text-align: center;
    padding: 2rem;
    color: var(--color-text-light, #6b7280);
    font-size: 0.875rem;
    border: 1px dashed var(--color-background-lighter, #e5e7eb);
    border-radius: 0.5rem;
    background: var(--color-background-light, #f9fafb);
  }

  /* ë°˜ì‘í˜• ë””ìì¸ */
  @media (max-width: 768px) {
    .giscus-container {
      margin-top: 1.5rem;
      margin-bottom: 1rem;
    }
  }

  /* ëŒ“ê¸€ ì„¹ì…˜ í—¤ë” */
  .giscus-container::after {
    content: '';
    display: block;
    width: 100%;
    height: 1px;
    background: linear-gradient(
      to right,
      transparent,
      var(--color-background-lighter, #e5e7eb) 20%,
      var(--color-background-lighter, #e5e7eb) 80%,
      transparent
    );
    margin-bottom: 1rem;
  }
</style>