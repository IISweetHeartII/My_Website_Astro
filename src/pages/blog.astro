---
import Layout from "@/layouts/Layout.astro";
import BlogCard from "@/features/blog/components/BlogCard.astro";
import CategoryFilter from "@/features/blog/components/CategoryFilter.astro";
import { getCollection, type CollectionEntry } from "astro:content";

// Helper function to get a valid timestamp or fallback
function getValidTimestamp(date: Date | null | undefined): number {
  if (!date) return 0;
  const timestamp = date.getTime();
  return isNaN(timestamp) ? 0 : timestamp;
}

const allPosts = (await getCollection("blog"))
  .filter((post: CollectionEntry<"blog">) => post.data.publish)
  .sort((a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) => {
    const dateA = getValidTimestamp(a.data.created_date);
    const dateB = getValidTimestamp(b.data.created_date);
    return dateB - dateA;
  });

// 카테고리 한글 -> 영문 ID 매핑
const categoryMap: Record<string, string> = {
  일상: "daily",
  개발: "dev",
  AI: "ai",
  보안: "security",
  교육: "education",
  DevOps: "devops",
  생산성: "productivity",
  블로그운영: "blog",
};
---

<Layout
  title="Blog - Ideas & Insights"
  description="Explore our collection of articles, ideas, insights, and everything in between."
>
  <div class="w-full max-w-4xl mx-auto p-8 flex flex-col">
    <!-- 카테고리 필터 시스템 -->
    <section class="mb-8">
      <CategoryFilter />
    </section>

    {
      allPosts.length > 0 ? (
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 flex-1 mb-8" id="blog-posts-grid">
          {allPosts.map((post: CollectionEntry<"blog">) => (
            <BlogCard
              title={post.data.title}
              description={post.data.description ?? undefined}
              date={post.data.created_date ?? undefined}
              slug={post.data.slug ?? post.id.replace(/\.[^/.]+$/, "")}
              dataTags={post.data.tags ? post.data.tags.join(",") : ""}
              dataTitle={post.data.title}
              dataDescription={post.data.description ?? ""}
              dataCategory={categoryMap[post.data.category] || "daily"}
            />
          ))}
        </div>
      ) : (
        <div class="text-center p-16 text-text text-lg flex-1 md:p-12 md:text-base">
          No posts found. Check back soon!
        </div>
      )
    }
  </div>
  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("post-search");
      const categoryFilterContainer = document.getElementById("category-filter-container");
      const blogPostsGrid = document.getElementById("blog-posts-grid");
      const resultsInfo = document.getElementById("results-info");

      if (!blogPostsGrid) {
        console.warn("Blog posts grid not found");
        return;
      }

      const allBlogCards = Array.from(blogPostsGrid.children);
      let currentSearchTerm = "";
      let currentSelectedCategory = "all";

      // 카테고리 이름 매핑
      const categoryNames = {
        all: "전체",
        daily: "일상",
        dev: "개발",
        ai: "AI",
        security: "보안",
        education: "교육",
        devops: "DevOps",
        productivity: "생산성",
        blog: "블로그운영",
      };

      // 필터링 함수
      const filterPosts = () => {
        let visibleCount = 0;

        allBlogCards.forEach((card) => {
          const cardTitle = (card.dataset.title || "").toLowerCase();
          const cardCategory = (card.dataset.category || "").toLowerCase();
          const cardDescription = (card.dataset.description || "").toLowerCase();

          const matchesSearch =
            currentSearchTerm === "" ||
            cardTitle.includes(currentSearchTerm) ||
            cardDescription.includes(currentSearchTerm);

          const matchesCategory =
            currentSelectedCategory === "all" || cardCategory === currentSelectedCategory;

          if (matchesSearch && matchesCategory) {
            card.style.display = "block";
            visibleCount++;
          } else {
            card.style.display = "none";
          }
        });

        // 결과 정보 업데이트
        if (resultsInfo) {
          const searchText = currentSearchTerm ? ` "${currentSearchTerm}"` : "";
          const categoryText =
            currentSelectedCategory !== "all" ? ` [${categoryNames[currentSelectedCategory]}]` : "";
          resultsInfo.innerHTML = `
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <span>${searchText}${categoryText} 검색 결과: <strong>${visibleCount}개</strong> / 전체 ${allBlogCards.length}개</span>
            </div>
          `;
        }
      };

      // 검색 이벤트
      if (searchInput) {
        searchInput.addEventListener("input", (event) => {
          currentSearchTerm = event.target.value.toLowerCase().trim();
          filterPosts();
        });
      }

      // 카테고리 클릭 이벤트
      if (categoryFilterContainer) {
        categoryFilterContainer.addEventListener("click", (event) => {
          const targetButton = event.target.closest("button[data-category]");

          if (targetButton) {
            // 이전 활성 카테고리 스타일 제거
            document.querySelectorAll(".current-category").forEach((btn) => {
              btn.classList.remove("current-category", "bg-primary", "text-background");
              btn.classList.add("bg-background-muted", "text-text-muted");
            });

            // 새 활성 카테고리 스타일 적용
            targetButton.classList.remove("bg-background-muted", "text-text-muted");
            targetButton.classList.add("current-category", "bg-primary", "text-background");

            currentSelectedCategory = targetButton.dataset.category;
            filterPosts();
          }
        });
      }

      // 초기 필터링
      filterPosts();
    });
  </script>

  <script>
    import { setupScrollAnimations } from "@/shared/scripts/scroll-animation";

    document.addEventListener("DOMContentLoaded", () => {
      setupScrollAnimations();
    });
  </script>
</Layout>
