---
import Layout from "@/layouts/Layout.astro";
import BlogCard from "@/features/blog/components/BlogCard.astro";
import CategoryFilter from "@/features/blog/components/CategoryFilter.astro";
import { getSortedPublishedPosts, transformPostForCard } from "@/shared/utils/blog";

const allPosts = await getSortedPublishedPosts();
const postsData = allPosts.map((post) => transformPostForCard(post));
---

<Layout
  title="Blog - Ideas & Insights"
  description="Explore our collection of articles, ideas, insights, and everything in between."
>
  <div class="w-full max-w-4xl mx-auto p-8 flex flex-col">
    <!-- 카테고리 필터 시스템 -->
    <section class="mb-8">
      <CategoryFilter />
    </section>

    {
      postsData.length > 0 ? (
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 flex-1 mb-8" id="blog-posts-grid">
          {postsData.map((post) => (
            <BlogCard
              title={post.title}
              description={post.description}
              date={post.date}
              slug={post.slug}
              dataTags={post.dataTags}
              dataTitle={post.dataTitle}
              dataDescription={post.dataDescription}
              dataCategory={post.dataCategory}
            />
          ))}
        </div>
      ) : (
        <div class="text-center p-16 text-text text-lg flex-1 md:p-12 md:text-base">
          No posts found. Check back soon!
        </div>
      )
    }
  </div>
  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("post-search");
      const categoryFilterContainer = document.getElementById("category-filter-container");
      const blogPostsGrid = document.getElementById("blog-posts-grid");
      const resultsInfo = document.getElementById("results-info");

      if (!blogPostsGrid) {
        console.warn("Blog posts grid not found");
        return;
      }

      const allBlogCards = Array.from(blogPostsGrid.children);
      let currentSearchTerm = "";
      let currentSelectedCategory = "all";

      // 카테고리 이름 매핑
      const categoryNames = {
        all: "전체",
        daily: "일상",
        dev: "개발",
        ai: "AI",
        security: "보안",
        education: "교육",
        devops: "DevOps",
        productivity: "생산성",
        blog: "블로그운영",
      };

      // 필터링 함수
      const filterPosts = () => {
        let visibleCount = 0;

        allBlogCards.forEach((card) => {
          const cardTitle = (card.dataset.title || "").toLowerCase();
          const cardCategory = (card.dataset.category || "").toLowerCase();
          const cardDescription = (card.dataset.description || "").toLowerCase();

          const matchesSearch =
            currentSearchTerm === "" ||
            cardTitle.includes(currentSearchTerm) ||
            cardDescription.includes(currentSearchTerm);

          const matchesCategory =
            currentSelectedCategory === "all" || cardCategory === currentSelectedCategory;

          if (matchesSearch && matchesCategory) {
            card.style.display = "block";
            visibleCount++;
          } else {
            card.style.display = "none";
          }
        });

        // 결과 정보 업데이트
        if (resultsInfo) {
          const searchText = currentSearchTerm ? ` "${currentSearchTerm}"` : "";
          const categoryText =
            currentSelectedCategory !== "all" ? ` [${categoryNames[currentSelectedCategory]}]` : "";
          resultsInfo.innerHTML = `
            <div class="flex items-center gap-2">
              <span>${searchText}${categoryText} 검색 결과: <strong>${visibleCount}개</strong> / 전체 ${allBlogCards.length}개</span>
            </div>
          `;
        }
      };

      // 검색 이벤트
      if (searchInput) {
        searchInput.addEventListener("input", (event) => {
          currentSearchTerm = event.target.value.toLowerCase().trim();
          filterPosts();
        });
      }

      // 카테고리 클릭 이벤트
      if (categoryFilterContainer) {
        categoryFilterContainer.addEventListener("click", (event) => {
          const targetButton = event.target.closest("button[data-category]");

          if (targetButton) {
            // 이전 활성 카테고리 스타일 제거
            document.querySelectorAll(".current-category").forEach((btn) => {
              btn.classList.remove("current-category", "bg-primary", "text-background");
              btn.classList.add("bg-background-muted", "text-text-muted");
            });

            // 새 활성 카테고리 스타일 적용
            targetButton.classList.remove("bg-background-muted", "text-text-muted");
            targetButton.classList.add("current-category", "bg-primary", "text-background");

            currentSelectedCategory = targetButton.dataset.category;
            filterPosts();
          }
        });
      }

      // 초기 필터링
      filterPosts();
    });
  </script>

  <script>
    import { setupScrollAnimations } from "@/shared/scripts/scroll-animation";

    document.addEventListener("DOMContentLoaded", () => {
      setupScrollAnimations();
    });
  </script>
</Layout>
