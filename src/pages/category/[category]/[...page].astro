---
import { type CollectionEntry, getCollection } from "astro:content";
import type { GetStaticPaths } from "astro";
import { Archive, Files, FileText, Tag } from "lucide-astro";
import BlogCard from "@/features/blog/components/BlogCard.astro";
import Layout from "@/layouts/Layout.astro";
import {
  type Category,
  categories,
  categoryMap,
  reverseCategoryMap,
} from "@/shared/config/categories";
import { sortPostsByDate, transformPostForCard } from "@/shared/utils/blog";

type Props = {
  page: {
    data: ReturnType<typeof transformPostForCard>[];
    start: number;
    end: number;
    size: number;
    total: number;
    currentPage: number;
    lastPage: number;
    url: {
      current: string;
      prev?: string;
      next?: string;
    };
  };
  category: Category;
  allCategories: Category[];
};

export const getStaticPaths = (async ({ paginate }) => {
  const posts = await getCollection("blog", ({ data }: CollectionEntry<"blog">) => {
    return data.publish !== false;
  });

  return categories.flatMap((category: Category) => {
    const filteredPosts = posts.filter((post: CollectionEntry<"blog">) => {
      const postCategoryId = categoryMap[post.data.category] || "daily";
      return postCategoryId === category.id;
    });

    const sortedPosts = sortPostsByDate(filteredPosts);
    const postsData = sortedPosts.map((post) => transformPostForCard(post));

    return paginate(postsData, {
      pageSize: 12,
      params: { category: category.id },
      props: {
        category: { ...category, name: reverseCategoryMap[category.id] || "일상" },
        allCategories: categories,
      },
    });
  });
}) satisfies GetStaticPaths;

const { category, allCategories, page } = Astro.props as Props;

const title = `${category.icon} ${category.name}`;
const description = category.description;
const pageTitle = page.currentPage === 1 ? title : `${title} (Page ${page.currentPage})`;
---

<Layout title={pageTitle} description={description}>
  <Fragment slot="head">
    {page.url.prev && <link rel="prev" href={page.url.prev} />}
    {page.url.next && <link rel="next" href={page.url.next} />}
  </Fragment>

  <div class="w-full max-w-7xl mx-auto p-8 flex flex-col">
    <section
      class="text-center mb-12 p-16 bg-linear-to-br from-primary/10 to-accent/10 rounded-3xl border-2 border-primary/20 md:p-12 md:mb-8"
    >
      <div class="text-6xl mb-4">{category.icon}</div>
      <h1 class="text-4xl md:text-5xl font-extrabold text-text mb-4 leading-tight">
        {category.name}
      </h1>
      <p class="text-lg text-text-muted max-w-2xl mx-auto leading-relaxed">
        {category.description}
      </p>
      <div class="mt-6 flex items-center justify-center gap-2 text-sm text-text-muted">
        <FileText class="w-5 h-5" />
        <span>
          <strong>{page.total}개</strong>의 글
        </span>
      </div>
    </section>

    <section class="mb-8">
      <div class="bg-background-light rounded-2xl p-6 border border-background-lighter">
        <h3 class="text-sm font-semibold text-text-muted mb-4 flex items-center gap-2">
          <Tag class="w-4 h-4" />
          다른 카테고리
        </h3>
        <div class="flex flex-wrap gap-2">
          {
            allCategories
              .filter((cat) => cat.id !== category.id)
              .map((cat) => (
                <a
                  href={`/category/${cat.id}/`}
                  class="px-4 py-2 rounded-lg bg-background hover:bg-primary hover:text-on-primary transition-all duration-200 font-medium text-sm flex items-center gap-2 border border-background-lighter hover:border-primary"
                >
                  <span>{cat.icon}</span>
                  <span>{cat.name}</span>
                </a>
              ))
          }
          <a
            href="/blog/"
            class="px-4 py-2 rounded-lg bg-background hover:bg-accent hover:text-on-primary transition-all duration-200 font-medium text-sm flex items-center gap-2 border border-background-lighter hover:border-accent"
          >
            <Archive class="w-4 h-4" />
            <span>전체 글</span>
          </a>
        </div>
      </div>
    </section>

    {
      page.data.length > 0 ? (
        <section class="flex-1">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {page.data.map((postData) => (
              <BlogCard
                title={postData.title}
                description={postData.description}
                date={postData.date}
                slug={postData.slug}
                dataTags={postData.dataTags}
                dataTitle={postData.dataTitle}
                dataDescription={postData.dataDescription}
                dataCategory={postData.dataCategory}
              />
            ))}
          </div>
        </section>
      ) : (
        <section class="flex-1 text-center py-16">
          <div class="text-text-muted mb-4">
            <Files class="w-24 h-24 mx-auto mb-4" />
          </div>
          <h3 class="text-xl font-semibold text-text mb-2">
            '{category.name}' 카테고리에 글이 아직 없어요
          </h3>
          <p class="text-text-muted">곧 멋진 글을 작성할 예정이니 기대해주세요!</p>
          <a
            href="/blog/"
            class="inline-block mt-6 px-6 py-3 bg-primary text-on-primary rounded-lg font-medium hover:bg-accent transition-colors"
          >
            전체 글 보기
          </a>
        </section>
      )
    }

    <nav aria-label="Pagination" class="mt-10 flex items-center justify-between gap-4">
      <div class="text-sm text-text-muted">
        {page.total > 0 && (
          <span>
            {page.start + 1}–{page.end + 1} / {page.total}
          </span>
        )}
      </div>

      <div class="flex items-center gap-2">
        <a
          href={page.url.prev ?? "#"}
          aria-disabled={!page.url.prev}
          class:list={[
            "px-3 py-2 rounded-lg border text-sm font-medium transition-colors duration-200",
            page.url.prev
              ? "bg-background hover:bg-background-light border-background-lighter text-text"
              : "bg-background-muted border-background-lighter text-text-muted pointer-events-none opacity-60",
          ]}
        >
          이전
        </a>
        <div class="text-sm text-text-muted px-2">
          {page.currentPage} / {page.lastPage}
        </div>
        <a
          href={page.url.next ?? "#"}
          aria-disabled={!page.url.next}
          class:list={[
            "px-3 py-2 rounded-lg border text-sm font-medium transition-colors duration-200",
            page.url.next
              ? "bg-background hover:bg-background-light border-background-lighter text-text"
              : "bg-background-muted border-background-lighter text-text-muted pointer-events-none opacity-60",
          ]}
        >
          다음
        </a>
      </div>
    </nav>
  </div>
</Layout>
