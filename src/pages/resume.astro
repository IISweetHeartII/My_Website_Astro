---
import { ExternalLink, FileDown } from "lucide-astro";
import { SITE_TITLE } from "@/shared/config/consts";
import { getUrl } from "@/shared/utils/url";
import Layout from "../layouts/Layout.astro";

interface ProofItem {
  id: string;
  label: string;
  date: string;
  image: string;
}

const awards: ProofItem[] = [
  {
    id: "finders-demoday",
    label: "UMC 9기 데모데이(Finders) 최우수상",
    date: "2026.02",
    image: "/images/awards/finders-demoday.jpg",
  },
  {
    id: "cheongryong-hackathon",
    label: "2026 청룡톤(119-ai) 대상",
    date: "2026.02",
    image: "/images/awards/cheongryong-hackathon.jpg",
  },
  {
    id: "umc9-hackathon",
    label: "UMC 9기 해커톤(행복일기) 대상",
    date: "2026.01",
    image: "/images/awards/umc9-hackathon.jpg",
  },
  {
    id: "ican-labs",
    label: "ICAN-LABs 창업 탐색 프로그램 최우수상",
    date: "2025.11",
    image: "/images/awards/ican-labs.jpg",
  },
  {
    id: "umc8-demoday",
    label: "UMC 8기 데모데이(오메추) 장려상",
    date: "2025.08",
    image: "/images/awards/umc8-demoday.jpg",
  },
  {
    id: "overseas-education",
    label: "기업가정신 해외교육 프로그램 최우수상",
    date: "2025.02",
    image: "/images/awards/overseas-education.jpg",
  },
];

const certifications: ProofItem[] = [
  {
    id: "engineer-info",
    label: "정보처리기사",
    date: "2025.09",
    image: "/images/awards/engineer-info.png",
  },
  { id: "sqld", label: "SQLD", date: "2025.09", image: "/images/awards/sqld.png" },
  { id: "opic-ih", label: "OPIc IH", date: "2024.12", image: "/images/awards/opic-ih.pdf" },
];
---

<Layout
  title={`Resume - ${SITE_TITLE}`}
  description="김덕환의 이력서 - 아끼지 않는 문제 해결사"
>
  <div class="resume-wrapper max-w-4xl mx-auto px-6 py-16 bg-background print:max-w-full print:p-0 print:m-0 print:bg-white">
    <!-- A4 Paper Simulation -->
    <div
      class="a4-page bg-background-light shadow-lg border border-background-lighter py-8 px-12
             min-h-[297mm] w-[210mm] mx-auto box-border
             max-md:w-full max-md:min-h-auto
             print:shadow-none print:border-0 print:min-h-auto print:w-full print:m-0
             print:pt-[15mm] print:pr-[15mm] print:pb-[12mm] print:pl-[15mm]"
    >
      <!-- Print Button (hidden on print) -->
      <div class="print:hidden mb-6 flex justify-between items-center">
        <a
          href={getUrl("/portfolio")}
          class="text-sm text-primary hover:text-primary-light font-medium flex items-center gap-1"
        >
          <ExternalLink class="w-4 h-4" />
          상세 포트폴리오 보기
        </a>
        <button
          id="print-btn"
          class="flex items-center gap-2 px-4 py-2 bg-primary text-on-primary text-sm font-semibold rounded-md hover:bg-primary-light transition-colors"
        >
          <FileDown class="w-4 h-4" />
          PDF로 저장
        </button>
      </div>
      <!-- Header -->
      <div class="flex justify-between items-start mb-4 pb-4 border-b-2 border-primary-light pl-4 border-l-4 border-l-primary">
        <div>
          <h1 class="text-3xl font-bold text-text mb-1">김덕환</h1>
          <p class="text-lg text-primary font-semibold">아끼지 않는 문제 해결사</p>
        </div>
        <div class="text-right text-sm text-text-light space-y-0.5">
          <p>sachi009955@gmail.com</p>
          <p>github.com/IISweetHeartII</p>
          <p>log8.kr</p>
        </div>
      </div>

      <!-- Summary -->
      <section class="mb-4">
        <h2 class="text-lg font-bold text-primary mb-2 border-b border-gray-300 pb-1">Summary</h2>
        <div class="text-sm text-text-light space-y-1">
          <p><strong class="font-semibold text-text">아끼지 않는 문제 해결사 김덕환</strong>입니다. 사람 중심 AI 제품으로 고객과 비즈니스의 실제 문제를 해결합니다.</p>
          <p class="text-text"><strong class="font-semibold">핵심 지표</strong>: 코드리뷰 400%↑, 복구 56h→5h, 학습 3x·개발 7x</p>
          <p class="text-text font-semibold">"아끼지 않는 문제 해결사"의 기준</p>
          <ul class="pl-4 list-disc space-y-0.5">
            <li>신기술 검증에 시간과 비용을 아끼지 않습니다.</li>
            <li>최신 지식과 실무 노하우를 적극 공유합니다.</li>
            <li>고객 가치, 비즈니스 임팩트, 제품 채택을 우선합니다.</li>
          </ul>
        </div>
      </section>

      <!-- Projects -->
      <section class="mb-4">
        <h2 class="text-lg font-bold text-primary mb-3 border-b border-gray-300 pb-1">Projects</h2>

        <!-- Project 1: Finders -->
        <div class="mb-5 project-card">
          <div class="mb-1.5">
            <h3 class="font-bold text-primary-light text-base">
              <a href={getUrl("/portfolio#finders")} class="hover:text-primary">
                BE Lead로 GCP 인프라 구축 및 팀 코드 리뷰 문화 정착
              </a>
            </h3>
            <span class="text-sm text-text-muted">2025.12 - 현재 | Backend Lead (5명 BE팀)</span>
          </div>
          <div class="grid grid-cols-2 gap-x-6 text-sm project-grid">
            <div>
              <p class="font-semibold text-text-light mb-1">문제 해결</p>
              <ul class="text-text-light space-y-0.5 pl-4 list-disc">
                <li>코드 리뷰 빈도 <strong class="font-semibold text-text">400% 증가(약 5배)</strong>로 품질 게이트 상향</li>
                <li>Terraform IaC로 복구 시간 <strong class="font-semibold text-text">56h → 5h</strong> 단축</li>
                <li>재구축 절차 스크립트화로 차기 리드타임 <strong class="font-semibold text-text">약 2h</strong> 예상</li>
              </ul>
            </div>
            <div>
              <p class="font-semibold text-text-light mb-1">구현</p>
              <ul class="text-text-light space-y-0.5 pl-4 list-disc">
                <li><strong class="font-semibold text-text">Java 21, Spring Boot 3.4</strong>, MySQL, QueryDSL</li>
                <li><strong class="font-semibold text-text">Terraform + GCP</strong> 서버/네트워크 코드화</li>
                <li><strong class="font-semibold text-text">CI/CD + VPC</strong>, dev/prod DB 분리, 롤백 배포</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Project 2: agentgram -->
        <div class="mb-5 project-card">
          <div class="mb-1.5">
            <h3 class="font-bold text-primary-light text-base">
              <a href="https://github.com/agentgram/agentgram" class="hover:text-primary">
                agentgram 오픈소스 코어 기여 및 멀티 레포 생태계 확장
              </a>
            </h3>
            <span class="text-sm text-text-muted">현재 진행 | Core Contributor (Open Source)</span>
          </div>
          <div class="grid grid-cols-2 gap-x-6 text-sm project-grid">
            <div>
              <p class="font-semibold text-text-light mb-1">문제 해결</p>
              <ul class="text-text-light space-y-0.5 pl-4 list-disc">
                <li>Vercel <strong class="font-semibold text-text">DAU 40</strong>, 활성 Agent <strong class="font-semibold text-text">70</strong> 운영</li>
                <li><strong class="font-semibold text-text">297+ 커밋</strong>, 코어/SDK/MCP/AX <strong class="font-semibold text-text">4레포</strong> 기여</li>
                <li>피드·팔로우·스토리·알림 등 <strong class="font-semibold text-text">16개+ 핵심 기능</strong> 고도화</li>
              </ul>
            </div>
            <div>
              <p class="font-semibold text-text-light mb-1">구현</p>
              <ul class="text-text-light space-y-0.5 pl-4 list-disc">
                <li><strong class="font-semibold text-text">Next.js 16</strong>, TailwindCSS v4</li>
                <li><strong class="font-semibold text-text">Supabase(PostgreSQL + RLS)</strong> API-first 구조</li>
                <li>Self-hosting + Docker + REST API/OpenAPI 운영</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Project 3: MathFigure -->
        <div class="mb-5 project-card">
          <div class="mb-1.5">
            <h3 class="font-bold text-primary-light text-base">
              <a href={getUrl("/portfolio#mathfigure")} class="hover:text-primary">
                ICAN-LABs 최우수상 수상, 40명 고객 인터뷰 기반 MVP
              </a>
            </h3>
            <span class="text-sm text-text-muted">2025.09 - 2025.12 | FE 중심 풀스택 1인 개발</span>
          </div>
          <div class="grid grid-cols-2 gap-x-6 text-sm project-grid">
            <div>
              <p class="font-semibold text-text-light mb-1">문제 해결</p>
              <ul class="text-text-light space-y-0.5 pl-4 list-disc">
                <li>고3 수능 콘텐츠 제작 시간 <strong class="font-semibold text-text">1/10로 단축</strong></li>
                <li><strong class="font-semibold text-text">40명</strong> 인터뷰로 "도구 복잡성" 핵심 Pain Point 도출</li>
                <li>I-Corps(미국 창업 검증) 기반 <strong class="font-semibold text-text">5주 압축 고객검증</strong>으로 MVP 방향성 확정</li>
              </ul>
            </div>
            <div>
              <p class="font-semibold text-text-light mb-1">구현</p>
              <ul class="text-text-light space-y-0.5 pl-4 list-disc">
                <li><strong class="font-semibold text-text">Next.js, MathJson</strong>, Fabric.js, JSXGraph</li>
                <li>수학 수식 파싱 + 도형 시각화 엔진</li>
                <li>FE 중심 MVP 프로토타입 구현 및 사용자 테스트 진행</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Project 4: 119-ai -->
        <div class="mb-4 project-card">
          <div class="mb-1.5">
            <h3 class="font-bold text-primary-light text-base">
              <a href="https://log8.kr" class="hover:text-primary">
                119-ai: Twilio AI 기반 병렬 전화로 응급 병원 매칭 시간 단축
              </a>
            </h3>
            <span class="text-sm text-text-muted">2026 | Founder / Owner</span>
          </div>
          <div class="grid grid-cols-2 gap-x-6 text-sm project-grid">
            <div>
              <p class="font-semibold text-text-light mb-1">문제 해결</p>
              <ul class="text-text-light space-y-0.5 pl-4 list-disc">
                <li>응급 이송 병목 해소를 위해 <strong class="font-semibold text-text">AI 병렬 발신</strong> 구조 설계</li>
                <li>환자 정보 1회 입력으로 인근 <strong class="font-semibold text-text">5+ 병원 동시 발신</strong> 자동화</li>
                <li>순차 전화(평균 5분+)를 병렬 처리(<strong class="font-semibold text-text">30초 이내</strong>)로 단축</li>
              </ul>
            </div>
            <div>
              <p class="font-semibold text-text-light mb-1">구현</p>
              <ul class="text-text-light space-y-0.5 pl-4 list-disc">
                <li><strong class="font-semibold text-text">Twilio + Gemini Live API</strong> 기반 음성 대화 자동화</li>
                <li><strong class="font-semibold text-text">NestJS + Python</strong>으로 AI 통화 파이프라인 구성</li>
                <li>건당 <strong class="font-semibold text-text">100~200원</strong> 수준의 비용 모델로 운영 가능성 검증</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Page Break for Print -->
      <div class="hidden print:block print:break-before-page"></div>

      <!-- Tech Stack -->
      <section class="mb-4 print:pt-[15mm]">
        <h2 class="text-lg font-bold text-primary mb-2 border-b border-gray-300 pb-1">Tech Stack</h2>
        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
          <div class="flex">
            <span class="font-semibold text-text w-20">Languages</span>
            <span class="text-text-light">TypeScript, Java, Python, C++</span>
          </div>
          <div class="flex">
            <span class="font-semibold text-text w-20">Frontend</span>
            <span class="text-text-light">Next.js, Astro, React, TailwindCSS</span>
          </div>
          <div class="flex">
            <span class="font-semibold text-text w-20">Backend</span>
            <span class="text-text-light">Spring Boot, NestJS, Supabase</span>
          </div>
          <div class="flex">
            <span class="font-semibold text-text w-20">Database</span>
            <span class="text-text-light">PostgreSQL, MySQL, pgvector</span>
          </div>
          <div class="flex col-span-2">
            <span class="font-semibold text-text w-20">DevOps</span>
            <span class="text-text-light">GCP (GCS, Cloud SQL, GCE), Docker, Cloudflare Tunnel, GitHub Actions, Sentry, tmux</span>
          </div>
        </div>
      </section>

      <!-- AI Orchestration -->
      <section class="mb-4">
        <h2 class="text-lg font-bold text-primary mb-2 border-b border-gray-300 pb-1">AI Orchestration Lab</h2>
        <ul class="text-sm text-text-light space-y-1 pl-4 list-disc">
          <li><strong class="font-semibold text-text">Antigravity + Claude Code Team(tmux) + OMO</strong> 멀티 에이전트 오케스트레이션 운영</li>
          <li>워크플로우 전환 후 <strong class="font-semibold text-text">학습량 3x</strong>, <strong class="font-semibold text-text">개발 속도 7x</strong> 향상</li>
          <li><strong class="font-semibold text-text">Rosie(OpenClaw)</strong>: Mac mini 24/7, heartbeat/cron, SNS·E2E·Google Workspace 자동화</li>
          <li><strong class="font-semibold text-text">Dave(OpenClaw)</strong>: 데스크탑 부팅 연동, E2E + 기능 사업성/수익성 검토</li>
        </ul>
      </section>

      <!-- Experience -->
      <section class="mb-4">
        <h2 class="text-lg font-bold text-primary mb-2 border-b border-gray-300 pb-1">Experience</h2>
        <div class="space-y-1.5 text-sm">
          <div class="flex justify-between">
            <div>
              <span class="font-semibold text-text">UMC 9기</span>
              <span class="text-text-light"> - <strong class="font-semibold text-text">Web 파트장</strong> (강의 및 멘토링), Spring Boot 챌린저</span>
            </div>
            <span class="text-text-muted">2025.09 - 현재</span>
          </div>
          <div class="flex justify-between">
            <div>
              <span class="font-semibold text-text">UMC 8기</span>
              <span class="text-text-light"> - Web 챌린저 (React, Next.js 학습)</span>
            </div>
            <span class="text-text-muted">2025.03 - 2025.08</span>
          </div>
          <div class="flex justify-between">
            <div>
              <span class="font-semibold text-text">AI 활용 강연</span>
              <span class="text-text-light"> - 시니어 소상공인 대상 (ChatGPT, Gemini Gems, NotebookLM)</span>
            </div>
            <span class="text-text-muted">2025.05, 07</span>
          </div>
          <div class="flex justify-between">
            <div>
              <span class="font-semibold text-text">AI 활용 강연</span>
              <span class="text-text-light"> - 리피움 창업가모임 (<strong class="font-semibold text-text">MCP, Agent AI</strong>)</span>
            </div>
            <span class="text-text-muted">2025.09</span>
          </div>
        </div>
      </section>

      <!-- Awards & Certifications -->
      <section class="mb-4">
        <h2 class="text-lg font-bold text-primary mb-2 border-b border-gray-300 pb-1">Awards & Certifications</h2>
        <div class="grid grid-cols-[3fr_2fr] gap-x-4 text-sm">
          <div>
            <p class="font-semibold text-text-light mb-1">Awards</p>
            <ul class="text-text-light space-y-0.5 pl-4 list-disc">
              {awards.map((award) => (
                <li
                  data-proof-id={award.id}
                  data-proof-image={award.image}
                  data-proof-title={award.label}
                  data-proof-date={award.date}
                  class="proof-item cursor-pointer rounded px-1 -mx-1 py-0.5 transition-colors hover:text-primary hover:bg-primary/5"
                >
                  {award.label} ({award.date})
                </li>
              ))}
            </ul>
          </div>
          <div>
            <p class="font-semibold text-text-light mb-1">Certifications</p>
            <ul class="text-text-light space-y-0.5 pl-4 list-disc">
              {certifications.map((cert) => (
                <li
                  data-proof-id={cert.id}
                  data-proof-image={cert.image}
                  data-proof-title={cert.label}
                  data-proof-date={cert.date}
                  class="proof-item cursor-pointer rounded px-1 -mx-1 py-0.5 transition-colors hover:text-primary hover:bg-primary/5"
                >
                  {cert.label} ({cert.date})
                </li>
              ))}
            </ul>
          </div>
        </div>
      </section>

      <!-- Education -->
      <section>
        <h2 class="text-lg font-bold text-primary mb-2 border-b border-gray-300 pb-1">Education</h2>
        <div class="text-sm">
          <div class="flex justify-between mb-1">
            <span class="font-semibold text-text">중앙대학교</span>
            <span class="text-text-muted">2020.03 - 2026.02 (졸업예정)</span>
          </div>
          <ul class="text-text-light space-y-0.5 pl-4 list-disc">
            <li>수학과 (주전공) / 소프트웨어인문 융합전공 (복수전공)</li>
            <li>교직이수 완료 (중등학교 정교사 2급 자격증 취득 예정)</li>
            <li>총 162학점 이수, 평균 학점 3.86/4.5</li>
          </ul>
        </div>
      </section>
    </div>

    <!-- Page 2 hint (optional, for longer content) -->
    <div class="print:hidden mt-4 text-center text-sm text-text-muted">
      A4 1페이지 미리보기 | 인쇄 시 자동 최적화
    </div>
  </div>

  <!-- Proof Panel Backdrop (narrow screens) -->
  <div
    id="proof-panel-backdrop"
    class="fixed inset-0 bg-black/30 z-30 opacity-0 pointer-events-none transition-opacity duration-300 print:hidden"
  ></div>

  <!-- Proof Panel -->
  <aside
    id="proof-panel"
    class="fixed right-0 top-0 h-screen w-[420px] max-w-[90vw] bg-background-light border-l border-background-lighter
           shadow-2xl z-40 translate-x-full transition-transform duration-500 ease-[cubic-bezier(0.4,0,0.2,1)]
           overflow-y-auto print:hidden"
    aria-hidden="true"
    role="dialog"
    aria-label="증빙 자료 보기"
  >
    <!-- Panel Header -->
    <div class="sticky top-0 bg-background-light/95 backdrop-blur-sm border-b border-background-lighter px-6 py-4 flex items-center justify-between z-10">
      <h3 id="proof-panel-title" class="text-base font-bold text-text truncate pr-4"></h3>
      <button
        id="proof-panel-close"
        class="shrink-0 w-9 h-9 flex items-center justify-center rounded-lg hover:bg-background-lighter transition-colors text-text-light hover:text-text"
        aria-label="패널 닫기"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Panel Body -->
    <div class="px-6 py-6">
      <!-- Image Container -->
      <div class="rounded-lg overflow-hidden border border-background-lighter bg-background-light mb-4 min-h-[200px] flex items-center justify-center">
        <img
          id="proof-panel-image"
          src=""
          alt=""
          class="w-full h-auto object-contain hidden"
        />
        <iframe
          id="proof-panel-document"
          src=""
          title="증빙 문서"
          class="w-full h-[560px] bg-white hidden"
        ></iframe>
        <!-- Loading placeholder -->
        <div id="proof-panel-loading" class="text-text-muted text-sm py-12">
          이미지 로딩 중...
        </div>
      </div>

      <!-- Date -->
      <p id="proof-panel-date" class="text-sm text-text-muted mb-4"></p>

      <!-- Download Button -->
      <a
        id="proof-panel-download"
        href=""
        download
        class="inline-flex items-center gap-2 px-4 py-2.5 bg-primary text-on-primary text-sm font-semibold rounded-md hover:bg-primary-light transition-colors w-full justify-center"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        증빙 자료 다운로드
      </a>
    </div>
  </aside>
</Layout>

<style>
  /* Resume shift when panel is open */
  .resume-wrapper {
    transition: margin-right 500ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  .resume-wrapper[data-panel="open"] {
    margin-right: calc(420px + 1.5rem);
  }

  /* On narrow screens, panel overlays instead of pushing */
  @media (max-width: 1200px) {
    .resume-wrapper[data-panel="open"] {
      margin-right: auto;
    }
  }

  /* Active proof item highlight */
  .proof-item-active {
    color: var(--color-primary) !important;
    background-color: color-mix(in srgb, var(--color-primary) 10%, transparent) !important;
    font-weight: 600;
  }

  /* 인쇄 전용 스타일 - TailwindCSS로 대체 불가능한 부분만 유지 */
  @media print {
    /* 전역 요소 숨김 - :global() 필수 */
    :global(header),
    :global(footer),
    :global(nav),
    :global([class*="ProgressIndicator"]),
    :global([class*="progress"]) {
      display: none !important;
    }

    /* 전체 body/html 초기화 - :global() 필수 */
    :global(html),
    :global(body) {
      margin: 0 !important;
      padding: 0 !important;
      background: white !important;
    }

    :global(body > main),
    :global(main.grow) {
      padding: 0 !important;
      margin: 0 !important;
    }

    /* A4 페이지 설정 - @page at-rule은 TailwindCSS 불가 */
    @page {
      size: A4;
      margin: 0;
    }

    /* 인쇄 시 색상 보존 - 브라우저 전용 속성 */
    html {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }

    .a4-page {
      background: white !important;
      word-break: keep-all;
      line-break: strict;
    }

    .resume-wrapper {
      background: white !important;
      margin-right: auto !important;
    }

    /* 인쇄 시 클릭 힌트 숨김 */
    .proof-item {
      cursor: default !important;
    }
  }
</style>

<script>
  function setupProofPanel(): void {
    const panel = document.getElementById("proof-panel");
    const panelTitle = document.getElementById("proof-panel-title");
    const panelImage = document.getElementById("proof-panel-image") as HTMLImageElement | null;
    const panelDocument = document.getElementById("proof-panel-document") as HTMLIFrameElement | null;
    const panelLoading = document.getElementById("proof-panel-loading");
    const panelDate = document.getElementById("proof-panel-date");
    const panelDownload = document.getElementById("proof-panel-download") as HTMLAnchorElement | null;
    const panelClose = document.getElementById("proof-panel-close");
    const backdrop = document.getElementById("proof-panel-backdrop");
    const resumeWrapper = document.querySelector(".resume-wrapper") as HTMLElement | null;
    const proofItems = document.querySelectorAll<HTMLElement>("[data-proof-id]");

    if (!panel || !panelTitle || !panelImage || !panelDocument || !panelClose || !resumeWrapper) return;

    let activeItemId: string | null = null;

    function openPanel(item: HTMLElement): void {
      const id = item.dataset["proofId"] ?? "";
      const image = item.dataset["proofImage"] ?? "";
      const title = item.dataset["proofTitle"] ?? "";
      const date = item.dataset["proofDate"] ?? "";

      // Toggle: clicking same item closes
      if (activeItemId === id) {
        closePanel();
        return;
      }

      const isPdf = image.toLowerCase().endsWith(".pdf");
      const ext = (image.split("?")[0]?.split("#")[0]?.split(".").pop() ?? "file").toLowerCase();

      // Show loading, hide media
      panelImage!.classList.add("hidden");
      panelDocument!.classList.add("hidden");
      panelDocument!.src = "";
      if (panelLoading) panelLoading.classList.remove("hidden");

      // Populate
      panelTitle!.textContent = title;
      panelImage!.alt = `${title} 증빙 자료`;
      if (panelDate) panelDate.textContent = date;
      if (panelDownload) {
        panelDownload.href = image;
        panelDownload.download = `${title}.${ext}`;
      }

      if (isPdf) {
        if (panelLoading) {
          panelLoading.textContent = "문서 로딩 중...";
          panelLoading.classList.add("hidden");
        }
        panelDocument!.src = image;
        panelDocument!.classList.remove("hidden");
      } else {
        if (panelLoading) {
          panelLoading.textContent = "이미지 로딩 중...";
        }

        // Image load handler
        panelImage!.onload = () => {
          panelImage!.classList.remove("hidden");
          if (panelLoading) panelLoading.classList.add("hidden");
        };
        panelImage!.onerror = () => {
          if (panelLoading) {
            panelLoading.textContent = "이미지를 찾을 수 없습니다";
            panelLoading.classList.remove("hidden");
          }
          panelImage!.classList.add("hidden");
        };
        panelImage!.src = image;
      }

      // Slide in
      panel!.classList.remove("translate-x-full");
      panel!.classList.add("translate-x-0");
      panel!.setAttribute("aria-hidden", "false");

      // Shift resume left
      resumeWrapper!.setAttribute("data-panel", "open");

      // Show backdrop on narrow screens
      if (backdrop) {
        backdrop.classList.remove("opacity-0", "pointer-events-none");
        backdrop.classList.add("opacity-100", "pointer-events-auto");
      }

      // Highlight active item
      for (const el of proofItems) {
        el.classList.toggle("proof-item-active", el.dataset["proofId"] === id);
      }

      activeItemId = id;
    }

    function closePanel(): void {
      panel!.classList.add("translate-x-full");
      panel!.classList.remove("translate-x-0");
      panel!.setAttribute("aria-hidden", "true");

      resumeWrapper!.removeAttribute("data-panel");

      if (backdrop) {
        backdrop.classList.add("opacity-0", "pointer-events-none");
        backdrop.classList.remove("opacity-100", "pointer-events-auto");
      }

      for (const el of proofItems) {
        el.classList.remove("proof-item-active");
      }

      activeItemId = null;
    }

    // Click handlers
    for (const item of proofItems) {
      item.addEventListener("click", () => openPanel(item));
    }

    // Close controls
    panelClose.addEventListener("click", closePanel);
    panelClose.addEventListener("pointerup", closePanel);
    backdrop?.addEventListener("click", closePanel);
    backdrop?.addEventListener("pointerup", closePanel);

    // ESC key
    document.addEventListener("keydown", (e: KeyboardEvent) => {
      if (e.key === "Escape" && activeItemId !== null) {
        closePanel();
      }
    });

    // Click outside panel closes it (additional safety for narrow viewports)
    document.addEventListener("click", (e: MouseEvent) => {
      if (activeItemId === null) return;
      const target = e.target as Element | null;
      if (!target) return;
      if (panel.contains(target)) return;
      if (target.closest("[data-proof-id]")) return;
      closePanel();
    });
  }

  // Print button
  document.getElementById("print-btn")?.addEventListener("click", () => {
    window.print();
  });

  // Support Astro View Transitions
  document.addEventListener("astro:page-load", setupProofPanel);
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupProofPanel);
  } else {
    setupProofPanel();
  }
</script>
