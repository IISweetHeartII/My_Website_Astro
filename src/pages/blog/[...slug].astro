---
import { type CollectionEntry, getCollection, render } from "astro:content";
import { getRelatedPosts } from "@/shared/utils/blog";
import { calculateReadingTime } from "@/shared/utils/reading-time";
import BlogPost from "../../layouts/BlogPost.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => {
    const slug = post.data.slug || post.id.replace(/\.[^/.]+$/, "");
    return {
      params: { slug },
      props: { post },
    };
  });
}

type Props = {
  post: CollectionEntry<"blog">;
};

const { post } = Astro.props;

// Render content and get headings
const { Content, headings } = await render(post);

// Reading time
const readingTime = calculateReadingTime(post.body ?? "");

// Related posts
const allPosts = (await getCollection("blog")).filter((p) => p.data.publish);
const relatedPosts = getRelatedPosts(post, allPosts);

// Series posts
let seriesPosts: CollectionEntry<"blog">[] = [];
if (post.data.series) {
  seriesPosts = allPosts
    .filter((p) => p.data.series === post.data.series)
    .sort((a, b) => (a.data.series_order ?? 0) - (b.data.series_order ?? 0));
}
---

<BlogPost
  data={post.data}
  readingTime={readingTime}
  headings={headings}
  relatedPosts={relatedPosts}
  currentPost={post}
  seriesPosts={seriesPosts}
>
  <Content />
</BlogPost>
