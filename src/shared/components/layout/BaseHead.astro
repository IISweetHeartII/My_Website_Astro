---
import "@/styles/global.css";
import { getUrl } from "@/shared/utils/url";
import Fonts from "@/shared/components/seo/Fonts.astro";
import { DEFAULT_OG_IMAGE } from "@/shared/config/consts";

interface Props {
  title: string;
  description?: string;
  featured_image?: string;
  featured_image_alt?: string;
  meta_title?: string;
  meta_description?: string;
  canonical_url?: string;
  og_title?: string;
  og_description?: string;
  og_image?: string;
  og_type?: string;
  twitter_title?: string;
  twitter_description?: string;
  twitter_image?: string;
  twitter_card?: string;
  keywords?: string[];
  author?: string;
  no_index?: boolean;
}

const canonicalURL = new globalThis.URL(Astro.url.pathname, Astro.site);

const {
  title,
  description,
  featured_image = DEFAULT_OG_IMAGE,
  featured_image_alt,
  meta_title,
  meta_description,
  canonical_url,
  og_title,
  og_description,
  og_image,
  og_type = "article",
  twitter_title,
  twitter_description,
  twitter_image,
  twitter_card = "summary_large_image",
  keywords = [],
  author,
  no_index = false,
} = Astro.props;

// Implement cascading fallbacks for all metadata fields
const finalMetaTitle = meta_title || title;
const finalMetaDescription = meta_description || description;

// Open Graph fallbacks
const finalOgTitle = og_title || finalMetaTitle;
const finalOgDescription = og_description || finalMetaDescription;
const finalOgImage = og_image || featured_image;

// Twitter fallbacks (Twitter → Open Graph → Meta → Default)
const finalTwitterTitle = twitter_title || finalOgTitle;
const finalTwitterDescription = twitter_description || finalOgDescription;
const finalTwitterImage = twitter_image || finalOgImage;

// Ensure all image URLs are absolute
const getAbsoluteImageUrl = (imageUrl: string) => {
  try {
    return new globalThis.URL(imageUrl, Astro.url).toString();
  } catch (e) {
    return imageUrl;
  }
};

const absoluteOgImage = getAbsoluteImageUrl(finalOgImage);
const absoluteTwitterImage = getAbsoluteImageUrl(finalTwitterImage);
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, shrink-to-fit=no" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="icon" type="image/png" href={getUrl("/images/design/icon.png")} />
<meta name="generator" content={Astro.generator} />
<meta name="naver-site-verification" content="18e465aad2a2421233f4ec39c0f509141b3f8048" />

<!-- Fonts -->
<Fonts />

<!-- Canonical URL -->
<link rel="canonical" href={canonical_url || canonicalURL} />

<!-- Primary Meta Tags -->
<title>{finalMetaTitle}</title>
<meta name="title" content={finalMetaTitle} />
<meta name="description" content={finalMetaDescription} />
{keywords.length > 0 && <meta name="keywords" content={keywords.join(", ")} />}
{author && <meta name="author" content={author} />}

<!-- Robots Meta Tags -->
{no_index && <meta name="robots" content="noindex, nofollow" />}

<!-- AEO (Answer Engine Optimization) Meta Tags -->
{finalMetaDescription && <meta name="abstract" content={finalMetaDescription.substring(0, 150)} />}
{keywords.length > 0 && <meta name="topic" content={keywords[0]} />}

<!-- Open Graph / Facebook -->
<meta property="og:type" content={og_type} />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={finalOgTitle} />
<meta property="og:description" content={finalOgDescription} />
<meta property="og:image" content={absoluteOgImage} />
{featured_image_alt && <meta property="og:image:alt" content={featured_image_alt} />}
{author && <meta property="article:author" content={author} />}

<!-- Twitter -->
<meta property="twitter:card" content={twitter_card} />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={finalTwitterTitle} />
<meta property="twitter:description" content={finalTwitterDescription} />
<meta property="twitter:image" content={absoluteTwitterImage} />
{featured_image_alt && <meta property="twitter:image:alt" content={featured_image_alt} />}

<!-- PWA Support -->
<link rel="manifest" href={getUrl("/manifest.json")} />
<link rel="apple-touch-icon" href={getUrl("/images/design/icon.png")} />

<!-- Google AdSense -->
<script
  async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4653332352131854"
  crossorigin="anonymous"></script>
